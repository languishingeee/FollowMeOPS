<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Follow-Me Ops | Pro v16.8 (Final)</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/723/723955.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        hud: { bg: '#020617', panel: 'rgba(15, 23, 42, 0.8)' },
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Rajdhani"', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'flash-red': 'flashRed 1.5s infinite'
                    },
                    keyframes: {
                        'slide-up': {
                            '0%': { opacity: 0, transform: 'translateY(15px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        },
                        'flashRed': {
                            '0%, 100%': { borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.15)' },
                            '50%': { borderColor: 'transparent', backgroundColor: 'transparent' }
                        }
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&family=Inter:wght@400;500;600;700&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(56, 189, 248, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.08), transparent 25%);
            background-attachment: fixed;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Modern Glass Panel */
        .glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 10px; }

        /* Flight Card Styles */
        .flight-card { 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
            border: 1px solid rgba(255,255,255,0.05);
            background: rgba(30, 41, 59, 0.4);
        }
        .flight-card:hover { 
            transform: translateY(-2px) scale(1.005); 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.4); 
            z-index: 20; 
            border-color: rgba(255,255,255,0.15); 
            background: rgba(30, 41, 59, 0.7);
        }
        
        .card-arr { border-left: 5px solid #10b981; background: linear-gradient(90deg, rgba(6, 78, 59, 0.2) 0%, rgba(30, 41, 59, 0.4) 100%); }
        .card-dep { border-left: 5px solid #f59e0b; background: linear-gradient(90deg, rgba(120, 53, 15, 0.2) 0%, rgba(30, 41, 59, 0.4) 100%); }

        .in-focus { opacity: 1; box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4), 0 10px 20px rgba(0,0,0,0.5); background: rgba(30, 41, 59, 0.8); z-index: 10; }
        .is-dimmed { opacity: 0.5; filter: grayscale(0.8); }
        .is-completed { opacity: 0.5; filter: grayscale(1) contrast(0.8); border-left-color: #64748b !important; background: rgba(15, 23, 42, 0.5); }

        .gate-input-wrapper:focus-within { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.2); }
        .gate-changed { animation: flash-red 1.5s infinite; border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; }
        @keyframes flash-red { 0%, 100% { box-shadow: 0 0 5px rgba(239, 68, 68, 0.5) inset; } 50% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.8) inset; } }

        @media screen and (max-width: 768px) { input, select, textarea { font-size: 16px !important; } }
        input.ghost { background: transparent; border: none; outline: none; width: 100%; color: inherit; }
        input.ghost::placeholder { color: rgba(255,255,255,0.2); font-weight: 500; }

        /* Report Canvas - Fixed visibility for html2canvas */
        #reportCapture { position: fixed; left: 0; top: 0; width: 1200px; height: 675px; background: #0f172a; z-index: -100; visibility: visible; }
        
        /* Shift Modal specific */
        .shift-btn { transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); }
        .shift-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
    </style>
</head>
<body class="flex flex-col h-screen text-gray-200 overflow-hidden">

    <div id="toastContainer" class="fixed top-24 right-4 left-4 md:left-auto md:right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <!-- HEADER -->
    <header class="h-16 glass flex items-center justify-between px-4 md:px-8 z-50 shrink-0 border-b border-white/5 relative shadow-lg">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
            <div class="relative">
                <div class="absolute inset-0 bg-blue-500 blur-lg opacity-20 group-hover:opacity-40 transition duration-500"></div>
                <div class="h-9 w-9 md:h-10 md:w-10 bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10 rounded-xl flex items-center justify-center relative z-10 shadow-inner">
                    <i class="fa-solid fa-tower-broadcast text-blue-400 text-lg transform group-hover:-translate-y-1 group-hover:translate-x-1 transition duration-500"></i>
                </div>
            </div>
            <div>
                <h1 class="font-display font-bold text-lg md:text-xl leading-none text-white tracking-wide group-hover:text-blue-400 transition">FOLLOW<span class="text-blue-500">ME</span></h1>
                <div class="text-[9px] md:text-[10px] text-gray-400 font-mono uppercase tracking-[0.3em] mt-0.5">Ops Center</div>
            </div>
        </div>

        <div class="hidden md:flex flex-col items-center absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
            <div id="liveClock" class="font-mono text-2xl md:text-3xl font-bold text-white tracking-tighter leading-none tabular-nums drop-shadow-md">00:00:00</div>
            <div class="flex items-center gap-2 mt-1 opacity-80">
                <span class="text-[9px] md:text-[10px] font-bold text-gray-400 uppercase tracking-widest border-r border-white/10 pr-2" id="liveDate">--.--.----</span>
                <span class="flex items-center gap-1 text-[9px] md:text-[10px] text-emerald-400 font-bold uppercase tracking-widest">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span> CANLI
                </span>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
            <button onclick="app.ui.toggleMobileSearch()" class="lg:hidden w-9 h-9 rounded-xl hover:bg-white/10 text-gray-300 flex items-center justify-center border border-transparent transition">
                <i class="fa-solid fa-search"></i>
            </button>

            <div class="relative group hidden lg:block">
                <i class="fa-solid fa-search absolute left-4 top-2.5 text-gray-500 group-focus-within:text-blue-400 transition-colors text-xs"></i>
                <input type="text" id="searchInput" placeholder="ARA..." 
                    class="bg-slate-900/50 border border-white/10 text-white text-xs rounded-xl block w-40 lg:w-48 pl-11 pr-8 py-2 focus:border-blue-500/50 focus:w-56 transition-all duration-300 outline-none font-mono uppercase placeholder-gray-600 shadow-inner">
                <button id="clearSearchBtn" onclick="app.ui.clearSearch()" class="hidden absolute right-2 top-2 text-gray-500 hover:text-white p-1 rounded-full hover:bg-white/10 transition"><i class="fa-solid fa-times text-[10px]"></i></button>
            </div>

            <div class="flex items-center gap-1 bg-slate-900/40 p-1 rounded-xl border border-white/5 shadow-lg backdrop-blur-sm">
                <button onclick="app.ui.toggleCompleted()" id="btnToggleCompleted" class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase text-gray-400 hover:text-white hover:bg-white/10 transition border border-transparent flex items-center gap-1.5" title="Geçmişi Gizle/Göster">
                    <i class="fa-solid fa-clock-rotate-left"></i> <span id="lblCompleted" class="hidden xl:inline">GİZLE</span>
                </button>
                <div class="w-px h-5 bg-white/10 mx-0.5 hidden sm:block"></div>
                <button onclick="app.ui.toggleAnalysis()" class="w-8 h-8 rounded-lg hover:bg-white/10 text-yellow-500 transition hidden sm:flex items-center justify-center" title="Analiz"><i class="fa-solid fa-chart-pie text-sm"></i></button>
                <button onclick="app.logic.generatePDF()" class="w-8 h-8 rounded-lg hover:bg-white/10 text-red-500 transition hidden sm:flex items-center justify-center" title="PDF"><i class="fa-solid fa-file-pdf text-sm"></i></button>
                <button onclick="app.ui.toggleSettings()" class="w-8 h-8 rounded-lg hover:bg-white/10 text-blue-400 transition hidden sm:flex items-center justify-center" title="Ekip"><i class="fa-solid fa-users-gear text-sm"></i></button>
                <button onclick="app.ui.toggleMenu()" class="w-8 h-8 rounded-lg hover:bg-white/10 text-gray-300 transition flex items-center justify-center relative" title="Ayarlar"><i class="fa-solid fa-gear text-sm"></i></button>
            </div>
        </div>
    </header>

    <div id="mobileSearch" class="hidden absolute top-16 left-0 w-full bg-[#0f172a] border-b border-white/10 p-3 z-40 animate-slide-down">
        <div class="relative">
            <i class="fa-solid fa-search absolute left-4 top-3 text-gray-500"></i>
            <input type="text" id="searchInputMobile" placeholder="UÇUŞ ARA (VF1054...)" 
                class="w-full bg-slate-900 border border-white/10 rounded-xl py-2.5 pl-10 pr-10 text-white text-base focus:border-blue-500 outline-none font-mono uppercase">
            <button onclick="app.ui.toggleMobileSearch()" class="absolute right-3 top-2.5 text-gray-400 hover:text-white p-1"><i class="fa-solid fa-times"></i></button>
        </div>
    </div>

    <div id="mainMenu" onclick="if(event.target===this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm transition-opacity">
        <div class="absolute top-20 right-4 w-72 glass rounded-2xl shadow-2xl animate-slide-up origin-top-right overflow-hidden border border-white/10">
            <div class="p-2 space-y-1">
                <div class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-widest border-b border-white/5 mb-1">Operasyon Menüsü</div>
                <div class="sm:hidden space-y-1 pb-2 border-b border-white/5 mb-1">
                    <button onclick="app.ui.toggleAnalysis()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-yellow-500 hover:text-yellow-400 text-left"><i class="fa-solid fa-chart-pie w-5"></i> Analiz</button>
                    <button onclick="app.logic.generatePDF()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-red-500 hover:text-red-400 text-left"><i class="fa-solid fa-file-pdf w-5"></i> PDF Rapor</button>
                    <button onclick="app.ui.toggleSettings()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-blue-400 hover:text-blue-300 text-left"><i class="fa-solid fa-users-gear w-5"></i> Ekip Yönetimi</button>
                </div>
                <label class="flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl cursor-pointer transition text-sm font-bold text-gray-300 hover:text-white group">
                    <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition"><i class="fa-solid fa-file-excel"></i></div>Excel Yükle <input type="file" id="fileInput" class="hidden" accept=".xlsx, .csv">
                </label>
                <button onclick="app.logic.generateVisualReport()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-bold text-gray-300 hover:text-white text-left group">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition"><i class="fa-solid fa-image"></i></div>Görsel Özet İndir
                </button>
                <div class="h-px bg-white/5 my-2"></div>
                <button onclick="app.data.saveToJson()" class="w-full flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-xl transition text-xs font-medium text-gray-400 hover:text-white text-left group"><i class="fa-solid fa-download w-5 text-center"></i> Yedek Al</button>
                <label class="w-full flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-xl transition text-xs font-medium text-gray-400 hover:text-white text-left group cursor-pointer"><i class="fa-solid fa-upload w-5 text-center"></i> Yedek Yükle <input type="file" onchange="app.data.loadFromJson(this)" class="hidden" accept=".json"></label>
                <div class="h-px bg-white/5 my-2"></div>
                <button onclick="app.ui.confirmReset()" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-red-500/10 rounded-xl transition text-xs font-bold text-red-500 text-left group">
                    <div class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500 group-hover:bg-red-500 group-hover:text-white transition"><i class="fa-solid fa-trash"></i></div>Sistemi Sıfırla
                </button>
            </div>
        </div>
    </div>

    <!-- Sticky Filter Bar with Active Shift Info -->
    <div class="bg-[#020617]/95 backdrop-blur border-b border-white/5 p-3 flex flex-col md:flex-row justify-between items-center gap-3 sticky top-0 z-40 shadow-xl overflow-x-auto no-scrollbar">
        <!-- Shift Info / Trigger -->
        <div class="flex items-center gap-2 cursor-pointer group shrink-0" onclick="app.ui.showShiftConfig()">
            <div class="w-8 h-8 rounded-lg bg-blue-600/10 border border-blue-600/30 flex items-center justify-center text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition">
                <i class="fa-solid fa-sliders"></i>
            </div>
            <div class="flex flex-col">
                <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">AKTİF VARDİYA</span>
                <span id="activeShiftLabel" class="text-xs font-bold text-white uppercase tracking-wide group-hover:text-blue-400 transition">VARDİYA YOK</span>
            </div>
        </div>

        <!-- View Filters -->
        <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto no-scrollbar pb-1 md:pb-0">
            <button onclick="app.ui.setFilter('all')" id="filter-all" class="flex-1 md:flex-none px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase transition text-white bg-white/10 border border-white/5 whitespace-nowrap">Tümü</button>
            <button onclick="app.ui.setFilter('focus')" id="filter-focus" class="flex-1 md:flex-none px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 border border-transparent whitespace-nowrap">Odak</button>
            <button onclick="app.ui.setFilter('completed')" id="filter-completed" class="flex-1 md:flex-none px-4 py-2.5 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 border border-transparent whitespace-nowrap">Bitenler</button>
        </div>
    </div>

    <main onclick="app.ui.closeMenus(event)" class="flex-1 overflow-y-auto p-2 md:p-6 lg:px-12 relative custom-scroll scroll-smooth">
        <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
            <div class="glass p-8 md:p-10 rounded-3xl border border-white/10 text-center max-w-sm pointer-events-auto shadow-2xl relative overflow-hidden mx-4">
                <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-50"></div>
                <div class="w-20 h-20 bg-blue-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 ring-1 ring-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.15)] relative z-10"><i class="fa-solid fa-tower-broadcast text-4xl text-blue-500 animate-pulse"></i></div>
                <h2 class="text-xl md:text-2xl font-display font-bold text-white mb-2 tracking-wide relative z-10">Vardiya Bekleniyor</h2>
                <p class="text-xs text-gray-400 mb-8 font-medium leading-relaxed relative z-10">Günlük operasyon listesini yükleyerek<br>sistemi aktif hale getirin.</p>
                <label class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl transition flex items-center justify-center gap-2 text-sm shadow-xl shadow-blue-600/20 active:scale-95 relative z-10"><i class="fa-solid fa-cloud-arrow-up"></i><span>DOSYA SEÇ</span><input type="file" onchange="app.logic.handleFileUpload(event)" class="hidden" accept=".xlsx, .csv"></label>
            </div>
        </div>
        <div id="flightGrid" class="grid grid-cols-1 xl:grid-cols-2 gap-3 md:gap-4 pb-32 relative z-10 max-w-8xl mx-auto"></div>
    </main>

    <footer class="h-14 glass border-t border-white/5 flex items-center justify-between px-4 md:px-6 text-[10px] font-bold text-gray-500 uppercase tracking-widest z-50">
        <div class="flex gap-4 md:gap-6 overflow-x-auto no-scrollbar w-full items-center">
            <span class="flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-list text-gray-400"></i><span class="hidden sm:inline">Toplam:</span><span id="statTotal" class="text-white">0</span></span>
            <span class="flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-eye text-blue-500"></i><span class="hidden sm:inline">Odak:</span><span id="statFocus" class="text-blue-400">0</span></span>
            <span class="flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-check-circle text-emerald-500"></i><span class="hidden sm:inline">Biten:</span><span id="statDone" class="text-emerald-400">0</span></span>
            <span class="flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-user-astronaut text-purple-500"></i><span class="hidden sm:inline">Atanan:</span><span id="statAssigned" class="text-purple-400">0</span></span>
        </div>
        <div id="saveStatus" class="opacity-0 transition-opacity text-emerald-500 flex items-center gap-2 font-bold tracking-wider hidden md:flex"><i class="fa-solid fa-floppy-disk animate-bounce"></i> <span>KAYITLI</span></div>
    </footer>

    <!-- MODALS -->

    <!-- Shift Config Modal (NEW) -->
    <div id="shiftConfigModal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[110] flex items-center justify-center p-4 transition-opacity">
        <div class="glass bg-slate-900 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden animate-slide-up border border-white/10">
            <div class="p-6 text-center border-b border-white/5">
                <div class="w-16 h-16 bg-blue-600/10 rounded-2xl flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-calendar-check text-3xl text-blue-500"></i></div>
                <h3 class="font-display font-bold text-2xl text-white">Vardiya Planlama</h3>
                <p class="text-xs text-gray-400 mt-2">Vardiya türünü ve odak saatlerini belirleyin.</p>
            </div>
            <div class="p-6 space-y-6">
                <!-- Shift Type Selection -->
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="app.ui.selectShiftType('day')" id="sc-btn-day" class="shift-btn active py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Gündüz</button>
                    <button onclick="app.ui.selectShiftType('night')" id="sc-btn-night" class="shift-btn py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Gece</button>
                    <button onclick="app.ui.selectShiftType('all')" id="sc-btn-all" class="shift-btn py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Tümü</button>
                </div>

                <!-- Custom Time Range -->
                <div id="customTimeRange" class="space-y-2">
                    <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Odak Saat Aralığı</label>
                    <div class="flex items-center gap-3">
                        <div class="flex-1 bg-black/30 rounded-xl border border-white/10 px-4 py-2 flex flex-col">
                            <span class="text-[9px] text-gray-500 font-bold mb-1">BAŞLANGIÇ</span>
                            <input type="time" id="sc-start" class="bg-transparent text-white font-mono font-bold text-lg outline-none" value="08:00">
                        </div>
                        <div class="text-gray-600"><i class="fa-solid fa-arrow-right"></i></div>
                        <div class="flex-1 bg-black/30 rounded-xl border border-white/10 px-4 py-2 flex flex-col">
                            <span class="text-[9px] text-gray-500 font-bold mb-1">BİTİŞ</span>
                            <input type="time" id="sc-end" class="bg-transparent text-white font-mono font-bold text-lg outline-none" value="20:00">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500 italic mt-2 text-center">* Gece vardiyasında bitiş saati ertesi günü temsil eder.</p>
                </div>

                <button onclick="app.logic.applyShiftConfig()" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition transform active:scale-95 uppercase tracking-wide text-sm">
                    Operasyonu Başlat
                </button>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div id="analysisModal" onclick="if(event.target === this) app.ui.toggleAnalysis()" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4 transition-opacity">
        <div class="glass bg-slate-900 rounded-3xl w-full max-w-5xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh] border border-white/10">
            <div class="p-4 md:p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center text-yellow-500"><i class="fa-solid fa-chart-line text-xl"></i></div>
                    <h3 class="font-display font-bold text-2xl text-white tracking-wide">Analiz</h3>
                </div>
                <button onclick="app.ui.toggleAnalysis()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition text-gray-400 hover:text-white"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="analysisContent" class="p-4 md:p-8 overflow-y-auto custom-scroll"></div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staffModal" onclick="if(event.target === this) app.ui.toggleSettings()" class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
        <div class="glass bg-slate-900 w-full max-w-md rounded-3xl overflow-hidden shadow-2xl animate-slide-up border border-white/10">
            <div class="p-5 border-b border-white/10 flex justify-between items-center bg-white/5">
                <h3 class="font-display font-bold text-lg text-white uppercase tracking-wide flex items-center gap-3"><i class="fa-solid fa-users text-blue-500"></i> Ekip Yönetimi</h3>
                <button onclick="app.ui.toggleSettings()" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            <div class="p-5">
                <div class="flex gap-3 mb-5">
                    <input type="text" id="newStaffName" placeholder="YENİ İSİM" class="flex-1 bg-slate-800 border border-white/10 rounded-xl px-4 py-2 text-base md:text-sm text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                    <button onclick="app.logic.addStaff()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-xl font-bold shadow-lg shadow-blue-600/30 transition transform active:scale-95"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div id="staffList" class="max-h-64 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
            </div>
        </div>
    </div>

    <!-- Reset Confirm Modal -->
    <div id="confirmModal" onclick="if(event.target === this) document.getElementById('confirmModal').classList.add('hidden')" class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl z-[110] flex items-center justify-center p-4">
        <div class="glass p-8 rounded-3xl text-center max-w-sm w-full animate-slide-up border border-red-500/30 shadow-[0_0_80px_rgba(239,68,68,0.2)] bg-[#0f172a]">
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 ring-1 ring-red-500/40"><i class="fa-solid fa-triangle-exclamation text-3xl"></i></div>
            <h3 class="text-xl font-display font-bold text-white mb-2">Emin misiniz?</h3>
            <p class="text-xs text-gray-400 mb-8 font-medium leading-relaxed">Tüm veriler silinecek.</p>
            <div class="flex gap-3">
                <button onclick="document.getElementById('confirmModal').classList.add('hidden')" class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-gray-300 rounded-xl font-bold text-xs uppercase transition tracking-wider border border-white/5">Vazgeç</button>
                <button onclick="app.ui.smartReset()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold text-xs uppercase shadow-lg shadow-red-600/30 transition tracking-wider transform hover:scale-[1.02]">TEMİZLE</button>
            </div>
        </div>
    </div>

    <datalist id="staffOptions"></datalist>

    <script>
        const downloadOrShare = async (blob, fileName, mimeType) => {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            // DIRECT DOWNLOAD (No Share) as requested for stability
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            return false;
        };

        const app = {
            state: { 
                flights: [], 
                shift: 'day',
                customStart: 480, // 08:00
                customEnd: 1200, // 20:00
                staff: ['AHMET Y.', 'MEHMET K.', 'AYŞE D.', 'FATMA S.', 'CAN B.'], 
                assignments: {}, gates: {}, overrides: {}, completed: [], 
                showCompleted: true, filterMode: 'all', baseDate: null 
            },
            init: () => {
                app.data.load(); app.ui.startClock(); app.ui.renderStaff(); app.ui.updateShiftUI(); app.ui.setFilter(app.state.filterMode); app.ui.updateCompletedBtn(); app.ui.updateHeaderShiftLabel();
                const updateDate = () => { document.getElementById('liveDate').innerText = new Date().toLocaleDateString('tr-TR'); };
                updateDate(); setInterval(updateDate, 60000);
                const searchInput = document.getElementById('searchInput'); const searchInputMobile = document.getElementById('searchInputMobile');
                const handleSearch = (e) => { const val = e.target.value; if(e.target.id === 'searchInput') { document.getElementById('clearSearchBtn').classList.toggle('hidden', val.length === 0); if(searchInputMobile) searchInputMobile.value = val; } else { if(searchInput) searchInput.value = val; document.getElementById('clearSearchBtn').classList.toggle('hidden', val.length === 0); } app.ui.render(); };
                if(searchInput) searchInput.addEventListener('input', handleSearch); if(searchInputMobile) searchInputMobile.addEventListener('input', handleSearch);
                setInterval(app.data.save, 15000);
            },
            ui: {
                toast: (msg, type = 'info') => {
                    const c = document.getElementById('toastContainer'); const d = document.createElement('div');
                    const cls = { success: 'border-emerald-500 bg-emerald-500/20 shadow-emerald-500/10 text-emerald-200', error: 'border-red-500 bg-red-500/20 shadow-red-500/10 text-red-200', info: 'border-blue-500 bg-blue-500/20 shadow-blue-500/10 text-blue-200' };
                    d.className = `p-3 rounded-xl border-l-4 backdrop-blur-xl shadow-2xl text-xs font-bold text-white animate-slide-in pointer-events-auto flex items-center gap-3 uppercase tracking-wide ${cls[type] || cls.info}`;
                    d.innerHTML = `<span>${msg}</span>`; c.appendChild(d); setTimeout(() => { d.style.opacity = '0'; d.style.transform = 'translateY(-10px)'; setTimeout(() => d.remove(), 300); }, 3000);
                },
                startClock: () => { setInterval(() => { const now = new Date(); document.getElementById('liveClock').innerText = now.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit', second:'2-digit'}); }, 1000); },
                clearSearch: () => { const el = document.getElementById('searchInput'); const elMob = document.getElementById('searchInputMobile'); if(el) el.value = ''; if(elMob) elMob.value = ''; app.ui.render(); },
                toggleMobileSearch: () => { const el = document.getElementById('mobileSearch'); el.classList.toggle('hidden'); if(!el.classList.contains('hidden')) { setTimeout(() => document.getElementById('searchInputMobile').focus(), 100); } },
                setFilter: (mode) => {
                    app.state.filterMode = mode;
                    ['all', 'focus', 'completed'].forEach(m => {
                        const btn = document.getElementById(`filter-${m}`); if(!btn) return;
                        if (m === mode) { btn.className = "px-4 md:px-6 py-1.5 md:py-2 rounded-xl text-[10px] font-bold uppercase transition text-white bg-blue-600 shadow-lg shadow-blue-600/30 border border-blue-500/50 transform scale-105"; } 
                        else { btn.className = "px-4 md:px-6 py-1.5 md:py-2 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 hover:text-white border border-transparent hover:bg-white/5"; }
                    }); app.ui.render();
                },
                toggleMenu: () => { const m = document.getElementById('mainMenu'); if(m) m.classList.toggle('hidden'); },
                closeMenus: (e) => { if(!e.target.closest('button') && !e.target.closest('#mainMenu') && !e.target.closest('#mobileSearch')) { document.getElementById('mainMenu').classList.add('hidden'); } },
                toggleSettings: () => { const m = document.getElementById('staffModal'); if(m) m.classList.toggle('hidden'); },
                toggleAnalysis: () => { const m = document.getElementById('analysisModal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) app.logic.analyze(); },
                confirmReset: () => { app.ui.toggleMenu(); document.getElementById('confirmModal').classList.remove('hidden'); },
                toggleCompleted: () => { app.state.showCompleted = !app.state.showCompleted; app.ui.updateCompletedBtn(); app.ui.render(); },
                updateCompletedBtn: () => { const lbl = document.getElementById('lblCompleted'); if(lbl) lbl.innerText = app.state.showCompleted ? "GİZLE" : "GÖSTER"; },
                
                showShiftConfig: () => {
                    document.getElementById('shiftConfigModal').classList.remove('hidden');
                    app.ui.selectShiftType(app.state.shift || 'day'); 
                },
                
                selectShiftType: (type) => {
                    ['day', 'night', 'all'].forEach(t => {
                        const btn = document.getElementById(`sc-btn-${t}`);
                        if(t === type) { btn.classList.add('active'); btn.classList.remove('bg-white/5', 'text-gray-400'); } 
                        else { btn.classList.remove('active'); btn.classList.add('bg-white/5', 'text-gray-400'); }
                    });
                    const startInp = document.getElementById('sc-start'); const endInp = document.getElementById('sc-end');
                    if (type === 'day') { startInp.value = "08:00"; endInp.value = "20:00"; } 
                    else if (type === 'night') { startInp.value = "20:00"; endInp.value = "08:00"; } 
                    else { startInp.value = "00:00"; endInp.value = "23:59"; }
                },

                updateHeaderShiftLabel: () => {
                    const label = document.getElementById('activeShiftLabel'); if(!label) return;
                    const s = app.state.shift;
                    const minsToTime = (m) => { let h = Math.floor(m/60); let mn = m%60; if(h>=24) h-=24; return `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`; };
                    let rangeStr = ""; if (s === 'all') rangeStr = "TÜM GÜN"; else { rangeStr = `${minsToTime(app.state.customStart)} - ${minsToTime(app.state.customEnd - (app.state.customEnd > 1440 ? 1440 : 0))}`; }
                    const name = s === 'day' ? 'GÜNDÜZ' : (s === 'night' ? 'GECE' : 'TÜMÜ');
                    label.innerText = `${name} (${rangeStr})`;
                },

                updateShiftUI: () => {
                   // This function is kept for compatibility but main update happens via label now
                },

                smartReset: () => {
                    // Direct reset logic, called from modal button
                    const currentStaff = app.state.staff;
                    app.state = {
                        flights: [],
                        shift: 'day',
                        customStart: 480, customEnd: 1200,
                        staff: currentStaff,
                        assignments: {},
                        gates: {},
                        overrides: {},
                        completed: [],
                        showCompleted: true,
                        filterMode: 'all',
                        baseDate: null
                    };
                    app.data.save(); app.ui.render(); app.ui.renderStaff(); app.ui.updateHeaderShiftLabel(); 
                    app.ui.toast("Sistem Temizlendi", "success");
                    document.getElementById('confirmModal').classList.add('hidden');
                },

                render: () => {
                    const grid = document.getElementById('flightGrid'); if(!grid) return; grid.innerHTML = '';
                    const elSearch = document.getElementById('searchInput'); const term = elSearch ? elSearch.value.toLowerCase().replace(/\s+/g, '') : '';
                    const flights = app.state.flights;
                    const emptyState = document.getElementById('emptyState');
                    if(flights.length === 0) { if(emptyState) emptyState.classList.remove('hidden'); return; } else { if(emptyState) emptyState.classList.add('hidden'); }
                    const sorted = [...flights].sort((a,b) => a.timestamp - b.timestamp);
                    let counts = { total: flights.length, focus: 0, done: app.state.completed.length, assigned: 0 };
                    
                    sorted.forEach((f, idx) => {
                        const searchStr = (f.flightNo + f.airline + f.gate + f.route + f.type + f.rawAirline + f.flightNoOnly).toLowerCase().replace(/\s+/g, '');
                        let match = searchStr.includes(term);
                        if(!match && term.length > 0) { const aliases = f.rawAirline.split('/').map(x => x.trim().toLowerCase()); match = aliases.some(a => (a + f.flightNoOnly).includes(term)); }
                        if(term && !match) return;
                        const isDone = app.state.completed.includes(f.id);
                        
                        // NEW: Dynamic Focus Logic
                        let inFocus = false;
                        if(app.state.overrides[f.id] === 'focus') inFocus = true;
                        else if(app.state.overrides[f.id] !== 'hide') {
                            const date = new Date(f.timestamp); 
                            const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0);
                            
                            if (app.state.shift === 'all') { inFocus = true; } 
                            else { if (m >= app.state.customStart && m <= app.state.customEnd) inFocus = true; }
                        }

                        if (app.state.filterMode === 'focus' && !inFocus) return; if (app.state.filterMode === 'completed' && !isDone) return; if (isDone && !app.state.showCompleted && app.state.filterMode !== 'completed') return;
                        if(inFocus && !isDone) counts.focus++; if(app.state.assignments[f.id]) counts.assigned++;
                        const originalGate = f.originalGate || ""; const savedGate = app.state.gates[f.id] !== undefined ? app.state.gates[f.id] : originalGate; const savedStaff = app.state.assignments[f.id] || ''; const isGateChanged = String(savedGate).trim() !== String(originalGate).trim();
                        const isArr = f.type === 'ARR'; const typeClass = isArr ? 'card-arr' : 'card-dep'; const icon = isArr ? 'fa-plane-arrival' : 'fa-plane-departure'; const label = isArr ? 'GELİŞ' : 'GİDİŞ'; const iconColor = isArr ? 'text-emerald-400' : 'text-amber-400';
                        const dateObj = new Date(f.timestamp); const dateLabel = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                        const el = document.createElement('div');
                        el.className = `flight-card rounded-xl flex flex-col md:flex-row min-h-auto md:min-h-[100px] ${typeClass} ${inFocus && !isDone ? 'in-focus' : 'is-dimmed'} ${isDone ? 'is-completed' : ''} mb-3 md:mb-4 relative overflow-hidden`;
                        const completedOverlay = isDone ? `<div class="absolute right-4 top-2 z-50 pointer-events-none transform -rotate-12 opacity-60"><div class="border-2 border-slate-400 text-slate-300 font-display font-bold text-sm md:text-lg px-2 py-0.5 rounded-lg uppercase tracking-widest shadow-2xl backdrop-blur-sm">TAMAMLANDI</div></div>` : '';
                        el.innerHTML = `${completedOverlay}
                            <div class="w-full md:w-28 bg-black/20 flex flex-row md:flex-col items-center justify-between p-3 md:p-4 border-b md:border-b-0 md:border-r border-white/5 relative group">
                                <div class="flex items-center gap-3 md:block md:text-center"><i class="fa-solid ${icon} ${iconColor} text-xl md:text-3xl drop-shadow-xl"></i><div class="md:hidden text-lg font-mono font-bold text-white">${f.timeStr}</div></div>
                                <div class="text-right md:text-center">
                                    <div class="hidden md:block text-2xl md:text-3xl font-mono font-bold text-white tracking-tighter leading-none">${f.timeStr}</div>
                                    <div class="text-[9px] font-bold text-indigo-400 bg-indigo-500/10 px-1 py-0.5 rounded border border-indigo-500/20 mt-1 uppercase text-center">${dateLabel}</div>
                                    <div class="text-[10px] font-extrabold ${isArr ? 'text-emerald-400' : 'text-amber-400'} tracking-widest mt-1 text-center border border-white/5 rounded bg-black/20 px-1">${isArr ? 'İNİŞ' : 'KALKIŞ'}</div>
                                </div>
                            </div>
                            <div class="flex-1 p-3 md:p-4 flex flex-col justify-center relative pl-4 md:pl-5">
                                <div class="flex items-center justify-between md:justify-start gap-4 mb-1"><div class="text-2xl md:text-4xl font-display font-bold text-white tracking-tight">${f.flightNo}</div><div class="text-[9px] md:text-[10px] font-bold text-gray-400 uppercase border border-white/10 px-2 py-0.5 rounded-lg bg-white/5 tracking-widest shadow-inner truncate max-w-[100px]">${f.airline}</div></div>
                                <div class="flex items-center gap-2 text-xs text-gray-400 font-mono mt-1 md:mt-2 font-bold opacity-80"><span class="w-4 h-4 md:w-5 md:h-5 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 shrink-0"><i class="fa-solid fa-route text-[8px] md:text-[9px]"></i></span><span class="truncate">${f.route}</span></div>
                            </div>
                            <div class="w-full md:w-72 p-3 flex flex-col justify-center gap-2 bg-black/10 border-t md:border-t-0 md:border-l border-white/5">
                                <div class="flex gap-2">
                                    <div class="flex-1 gate-input-wrapper rounded-lg p-0.5 ${isGateChanged ? 'gate-changed' : ''}"><label class="block text-[8px] text-gray-500 font-bold uppercase text-center tracking-wider pt-0.5">KAPI</label><input type="text" value="${savedGate}" onchange="app.logic.updateGate('${f.id}', this.value)" class="ghost text-center font-mono font-bold text-lg md:text-xl text-white tracking-widest h-8" placeholder="---"></div>
                                    <div class="flex flex-col gap-1 w-9"><button onclick="app.logic.toggleOverride('${f.id}', '${inFocus ? 'hide' : 'focus'}')" class="flex-1 rounded bg-white/10 hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center h-8 md:h-auto"><i class="fa-solid ${inFocus ? 'fa-eye-slash' : 'fa-thumbtack'} text-[10px]"></i></button><button onclick="app.logic.toggleComplete('${f.id}')" class="flex-1 rounded ${isDone ? 'bg-slate-600 text-white' : 'bg-emerald-600/20 hover:bg-emerald-600 text-emerald-500 hover:text-white'} transition flex items-center justify-center border border-emerald-500/20 hover:border-emerald-500 h-8 md:h-auto"><i class="fa-solid ${isDone ? 'fa-rotate-left' : 'fa-check'} text-[10px]"></i></button></div>
                                </div>
                                <div class="relative group"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fa-solid fa-user-astronaut text-[10px] text-gray-500 group-hover:text-blue-400 transition"></i></div><input list="staffOptions" value="${savedStaff}" onchange="app.logic.assignStaff('${f.id}', this.value)" placeholder="PERSONEL..." class="w-full bg-white/5 hover:bg-white/10 focus:bg-blue-600/10 border border-white/10 focus:border-blue-500/50 rounded-lg text-base md:text-[10px] font-bold text-white py-2 pl-8 pr-2 outline-none transition uppercase tracking-wide placeholder-gray-600 text-center shadow-sm"></div>
                            </div>
                        `;
                        grid.appendChild(el);
                    });
                    document.getElementById('statTotal').innerText = sorted.length; document.getElementById('statFocus').innerText = counts.focus; document.getElementById('statDone').innerText = counts.done; document.getElementById('statAssigned').innerText = counts.assigned;
                },
                renderStaff: () => {
                    const counts = {}; app.state.staff.forEach(s => counts[s] = 0); app.state.completed.forEach(fid => { const s = app.state.assignments[fid]; if(s && counts.hasOwnProperty(s)) counts[s]++; });
                    document.getElementById('staffOptions').innerHTML = app.state.staff.map(s => `<option value="${s}">`).join('');
                    document.getElementById('staffList').innerHTML = app.state.staff.map(s => `
                        <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/5 group hover:border-white/20 transition hover:bg-white/10 hover:translate-x-1 duration-200"><span class="text-xs font-bold text-gray-300 uppercase tracking-wide flex items-center gap-3"><span class="w-6 h-6 rounded bg-blue-500/10 flex items-center justify-center text-blue-400"><i class="fa-solid fa-user-astronaut text-[10px]"></i></span>${s}</span><div class="flex items-center gap-2"><span class="text-[10px] font-bold text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20">${counts[s] || 0}</span><button onclick="app.logic.removeStaff('${s}')" class="text-gray-500 hover:text-red-400 p-1.5"><i class="fa-solid fa-trash text-xs"></i></button></div></div>
                    `).join('');
                }
            },
            logic: {
                handleFileUpload: (e) => { const file = e.target.files[0]; if (!file) return; const r = new FileReader(); r.onload = (evt) => { const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' }); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws, { header: 1 }); app.logic.parse(json); }; r.readAsArrayBuffer(file); e.target.value = ''; },
                parse: (rows) => {
                    let hIdx = -1, dateStr = "";
                    for(let i=0; i<Math.min(rows.length, 25); i++) { const s = rows[i].join(" ").toUpperCase(); if(s.match(/(\d{2}\.\d{2}\.\d{4})/)) dateStr = s.match(/(\d{2}\.\d{2}\.\d{4})/)[1]; if(s.includes("FLIGHT NO") && s.includes("AIRLINE")) { hIdx = i; break; } }
                    if(hIdx === -1) { app.ui.toast("Header Bulunamadı!", "error"); return; }
                    const header = rows[hIdx].map(x => String(x).toUpperCase().trim());
                    const m = { airline: -1, gate: -1, route: -1, arrNo: -1, arrTime: -1, depNo: -1, depTime: -1 };
                    header.forEach((c, i) => { if(c.includes("AIRLINE")) m.airline = i; if(c.includes("BRIDGE") || c.includes("GATE")) m.gate = i; if(c.includes("STATIONS") || c.includes("ROUTE")) m.route = i; });
                    const split = Math.floor(header.length/2);
                    header.forEach((c, i) => { if(i < split) { if(c.includes("FLIGHT") || c.includes("NO")) m.arrNo = i; if(c.includes("STA") || c.includes("TIME")) m.arrTime = i; } else { if((c.includes("FLIGHT") || c.includes("NO")) && m.depNo === -1) m.depNo = i; if((c.includes("STD") || c.includes("TIME")) && m.depTime === -1) m.depTime = i; } });
                    const toMins = (v) => { if(typeof v === 'number') return Math.round(v * 1440); if(typeof v === 'string' && v.includes(':')) { const [h,m] = v.split(':').map(Number); return h*60+m; } return null; };
                    const data = rows.slice(hIdx+1); app.state.flights = []; let baseDate = new Date(); if(dateStr) { const p = dateStr.split('.'); baseDate = new Date(p[2], p[1]-1, p[0]); } app.state.baseDate = baseDate.toISOString();
                    data.forEach((row, idx) => {
                        const air = row[m.airline] || ""; const gate = row[m.gate] || ""; const routeRaw = row[m.route] || ""; let from = routeRaw, to = routeRaw; if(routeRaw.includes("-")) { const p = routeRaw.split("-"); from=p[0].trim(); to=p[1].trim(); }
                        const createFlight = (t, type, no, route) => { const isNextDay = t < 900; const d = new Date(baseDate); if(isNextDay) d.setDate(d.getDate() + 1); const h = Math.floor(t/60), mn = t%60; d.setHours(h, mn, 0, 0); const fClean = String(no).trim(); const numMatch = fClean.match(/\d+/); const fNum = numMatch ? numMatch[0] : fClean; return { id: `${type}-${idx}-${Math.random().toString(36).substr(2,5)}`, type: type, flightNo: fClean, flightNoOnly: fNum, rawAirline: String(air).trim(), airline: String(air).split('/')[0].trim(), gate: String(gate).trim(), originalGate: String(gate).trim(), route: route, timestamp: d.getTime(), timeStr: `${String(h).padStart(2,'0')}:${String(mn).padStart(2,'0')}`, isNextDay: isNextDay }; };
                        if(row[m.arrNo] && row[m.arrTime]) { const tm = toMins(row[m.arrTime]); if(tm !== null) app.state.flights.push(createFlight(tm, 'ARR', row[m.arrNo], from)); }
                        if(row[m.depNo] && row[m.depTime]) { const tm = toMins(row[m.depTime]); if(tm !== null) app.state.flights.push(createFlight(tm, 'DEP', row[m.depNo], to)); }
                    });
                    app.state.flights.sort((a,b) => a.timestamp - b.timestamp); app.data.save(); 
                    // TRIGGER WIZARD
                    app.ui.showShiftConfig();
                    app.ui.toast("Dosya Okundu. Vardiya Seçin.", "success");
                },
                applyShiftConfig: () => {
                    let type = 'all'; if(document.getElementById('sc-btn-day').classList.contains('active')) type = 'day'; else if(document.getElementById('sc-btn-night').classList.contains('active')) type = 'night';
                    const startVal = document.getElementById('sc-start').value; const endVal = document.getElementById('sc-end').value;
                    const timeToMins = (t) => { const [h,m] = t.split(':').map(Number); return h*60 + m; };
                    let startMins = timeToMins(startVal); let endMins = timeToMins(endVal);
                    if (endMins < startMins) { endMins += 1440; }
                    app.state.shift = type; app.state.customStart = startMins; app.state.customEnd = endMins;
                    document.getElementById('shiftConfigModal').classList.add('hidden'); app.ui.updateHeaderShiftLabel(); app.ui.render(); app.data.save(); app.ui.toast("Vardiya Başlatıldı", "success");
                },
                setShift: (s) => { app.ui.showShiftConfig(); }, // Re-opens wizard
                toggleOverride: (id, act) => { if(app.state.overrides[id] === act) delete app.state.overrides[id]; else app.state.overrides[id] = act; app.data.save(); app.ui.render(); },
                toggleComplete: (id) => { if(app.state.completed.includes(id)) app.state.completed = app.state.completed.filter(x => x!==id); else app.state.completed.push(id); app.data.save(); app.ui.render(); app.ui.renderStaff(); },
                assignStaff: (id, val) => { app.state.assignments[id] = val; app.data.save(); app.ui.render(); app.ui.renderStaff(); },
                updateGate: (id, val) => { app.state.gates[id] = val; app.data.save(); app.ui.render(); },
                addStaff: () => { const v = document.getElementById('newStaffName').value.trim().toUpperCase(); if(v && !app.state.staff.includes(v)) { app.state.staff.push(v); document.getElementById('newStaffName').value = ''; app.ui.renderStaff(); app.data.save(); app.ui.toast("Eklendi", "success"); } },
                removeStaff: (s) => { app.state.staff = app.state.staff.filter(x => x !== s); app.ui.renderStaff(); app.data.save(); },
                analyze: () => {
                    const f = app.state.flights; if(!f.length) return;
                    let hourCounts = {}, shiftFlightCount = 0;
                    const sortedF = [...f].sort((a,b) => a.timestamp - b.timestamp);
                    sortedF.forEach(flight => {
                        const h = new Date(flight.timestamp).getHours(); const hKey = String(h).padStart(2,'0'); hourCounts[hKey] = (hourCounts[hKey] || 0) + 1;
                        const m = new Date(flight.timestamp).getHours() * 60 + new Date(flight.timestamp).getMinutes() + (flight.isNextDay ? 1440 : 0);
                        let inShift = false; if(app.state.shift === 'all') inShift = true; else if (m >= app.state.customStart && m <= app.state.customEnd) inShift = true; if(inShift) shiftFlightCount++;
                    });
                    const orderedHours = [...new Set(sortedF.map(flight => String(new Date(flight.timestamp).getHours()).padStart(2,'0')))]; const maxVal = Math.max(...Object.values(hourCounts), 1);
                    const chartHtml = orderedHours.map(h => { const count = hourCounts[h]; const pct = (count / maxVal) * 100; const color = count > 5 ? 'bg-red-500' : (count > 2 ? 'bg-blue-500' : 'bg-emerald-500'); return `<div class="flex flex-col items-center gap-1 min-w-[25px]"><div class="w-full bg-white/5 rounded-t relative h-24 flex items-end"><div class="w-full ${color} opacity-80" style="height: ${pct}%"></div></div><div class="text-[9px] font-mono text-gray-500">${h}</div></div>`; }).join('');
                    let gaps = []; for(let i=0; i<sortedF.length-1; i++) { const diff = (sortedF[i+1].timestamp - sortedF[i].timestamp)/60000; if(diff > 45) { const start = sortedF[i].timeStr; const end = sortedF[i+1].timeStr; gaps.push({ start, end, min: Math.floor(diff) }); } }
                    document.getElementById('analysisContent').innerHTML = `<div class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="glass p-4 rounded-xl border-l-4 border-blue-500"><div class="text-xs text-blue-400 uppercase font-bold">Toplam İş</div><div class="text-3xl font-bold text-white">${f.length}</div></div><div class="glass p-4 rounded-xl border-l-4 border-emerald-500"><div class="text-xs text-emerald-400 uppercase font-bold">Vardiya Odağı</div><div class="text-3xl font-bold text-white">${shiftFlightCount}</div></div></div><div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-4">Saatlik Akış</h4><div class="flex items-end gap-2 overflow-x-auto pb-2">${chartHtml}</div></div><div class="glass p-4 rounded-xl border border-white/5"><h4 class="text-xs text-gray-400 uppercase font-bold mb-3">Mola Fırsatları (>45dk)</h4><div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2">${gaps.length ? gaps.map(g => `<div class="flex justify-between text-sm bg-black/20 p-2 rounded border-l-2 border-green-500"><span class="text-white font-mono">${g.start} - ${g.end}</span><span class="text-green-400 font-bold">${g.min} dk</span></div>`).join('') : '<div class="text-gray-500 text-xs italic">Yoğun akış, boşluk yok.</div>'}</div></div></div>`;
                },
                generatePDF: async () => {
                    const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                    app.ui.toast("PDF Hazırlanıyor...", "info");
                    const trMap = (str) => str.replace(/Ğ/g, "G").replace(/ğ/g, "g").replace(/Ü/g, "U").replace(/ü/g, "u").replace(/Ş/g, "S").replace(/ş/g, "s").replace(/İ/g, "I").replace(/ı/g, "i").replace(/Ö/g, "O").replace(/ö/g, "o").replace(/Ç/g, "C").replace(/ç/g, "c");
                    doc.setFillColor(15, 23, 42); doc.rect(0, 0, 297, 35, 'F');
                    doc.setTextColor(255, 255, 255); doc.setFontSize(26); doc.setFont("helvetica", "bold"); doc.text("FOLLOW-ME", 15, 18); doc.setTextColor(59, 130, 246); doc.text("OPS", 72, 18);
                    doc.setTextColor(148, 163, 184); doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text("KOMUTA MERKEZI VARDIYA RAPORU", 15, 26);
                    let reportDate = new Date(); if (app.state.baseDate) { reportDate = new Date(app.state.baseDate); }
                    const dateStr = trMap(reportDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' }));
                    
                    // Dynamic Shift Logic for PDF
                    let shiftStr = "TUMU";
                    if(app.state.shift !== 'all') {
                        const hStart = Math.floor(app.state.customStart/60); const hEnd = Math.floor((app.state.customEnd > 1440 ? app.state.customEnd - 1440 : app.state.customEnd)/60);
                        const rangeStr = `${String(hStart).padStart(2,'0')}-${String(hEnd).padStart(2,'0')}`;
                        shiftStr = app.state.shift === 'day' ? `GUNDUZ (${rangeStr})` : `GECE (${rangeStr})`;
                    }

                    doc.text(`TARIH: ${dateStr}`, 282, 16, { align: 'right' }); doc.text(`VARDIYA: ${shiftStr}`, 282, 24, { align: 'right' });
                    const buffer = 20; const flights = app.state.flights; let filteredFlights = [];
                    if (app.state.shift === 'all') { filteredFlights = flights.map(f => ({...f, isBuffer: false})); } 
                    else {
                        const startM = app.state.customStart; const endM = app.state.customEnd;
                        const bufStart = startM - buffer; const bufEnd = endM + buffer;
                        filteredFlights = flights.filter(f => { const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0); return (m >= bufStart && m <= bufEnd); }).map(f => { const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0); const isBuffer = (m < startM || m > endM); return { ...f, isBuffer }; });
                    }
                    const flightCount = filteredFlights.filter(f => !f.isBuffer).length;
                    doc.setTextColor(255, 255, 255); doc.setFontSize(12); doc.text(`RAPORLANAN: ${flightCount}`, 160, 24, { align: 'center' });
                    const rows = filteredFlights.map(f => {
                        const savedGate = app.state.gates[f.id] !== undefined ? app.state.gates[f.id] : (f.originalGate || ""); const isChanged = String(savedGate).trim() !== String(f.originalGate || "").trim(); const gateDisplay = isChanged ? `${savedGate} (!)` : savedGate; const isCompleted = app.state.completed.includes(f.id);
                        return [
                            f.timeStr, 
                            f.type === 'ARR' ? 'GELIS' : 'GIDIS', 
                            f.flightNo, 
                            trMap(f.airline), 
                            gateDisplay, 
                            trMap(f.route), 
                            trMap(app.state.assignments[f.id] || '-'), 
                            isCompleted ? 'TAMAMLANDI' : 'BEKLIYOR'
                        ];
                    });
                    doc.autoTable({ startY: 40, head: [['SAAT', 'TIP', 'UCUS NO', 'HAVAYOLU', 'PARK', 'FROM / TO', 'PERSONEL', 'DURUM']], body: rows, theme: 'grid', styles: { font: 'helvetica', fontSize: 9, cellPadding: 3, lineColor: [226, 232, 240], lineWidth: 0.1, textColor: [51, 65, 85] }, headStyles: { fillColor: [241, 245, 249], textColor: [71, 85, 105], fontStyle: 'bold', lineWidth: 0, valign: 'middle' }, columnStyles: { 0: { fontStyle: 'bold', halign: 'center', cellWidth: 20 }, 1: { fontStyle: 'bold', halign: 'center', cellWidth: 20 }, 2: { fontStyle: 'bold', halign: 'left', cellWidth: 25 }, 4: { fontStyle: 'bold', halign: 'center', cellWidth: 20 }, 7: { halign: 'center', cellWidth: 30, fontStyle: 'bold' } }, alternateRowStyles: { fillColor: [255, 255, 255] }, didParseCell: (data) => { if (data.section === 'body') { if (filteredFlights[data.row.index].isBuffer) { data.cell.styles.textColor = [156, 163, 175]; data.cell.styles.fontStyle = 'italic'; } else { if (data.column.index === 1) { if (data.cell.raw === 'GELIS') data.cell.styles.textColor = [22, 163, 74]; else data.cell.styles.textColor = [234, 88, 12]; } if (data.column.index === 4 && data.cell.raw.includes('(!)')) { data.cell.styles.textColor = [220, 38, 38]; } if (data.column.index === 7) { if (data.cell.raw === 'TAMAMLANDI') data.cell.styles.textColor = [100, 116, 139]; else data.cell.styles.textColor = [59, 130, 246]; } } } } });
                    const pageCount = doc.internal.getNumberOfPages(); for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Sayfa ${i} / ${pageCount}`, 148, 200, { align: 'center' }); doc.setFontSize(7); doc.setTextColor(100); doc.text("Not: Vardiya sorumluluk sahasinin ±20 dakika toleransindaki ucuslar rapora dahil edilmistir.", 14, 200); }
                    
                    // DIRECT DOWNLOAD (Requested for v16.3+)
                    doc.save(`FollowMe_Rapor_${new Date().toISOString().slice(0,10)}.pdf`); 
                    app.ui.toast("PDF İndirildi", "success");
                },
                generateVisualReport: async () => {
                   app.ui.toast("Görsel Hazırlanıyor...", "info");
                   const container = document.createElement('div'); container.id = 'reportCapture'; 
                   container.style.position = 'fixed'; container.style.left = '0'; container.style.top = '0'; container.style.width = '1200px'; container.style.height = '675px'; container.style.zIndex = '9999'; 
                   document.body.appendChild(container);
                   const flights = app.state.flights; let plannedCount = 0;
                   const shiftFiltered = flights.filter(f => {
                        const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0);
                        if(app.state.shift === 'all') return true;
                        return (m >= app.state.customStart && m <= app.state.customEnd);
                   });
                   shiftFiltered.forEach(f => { plannedCount++; });
                   const servedIDs = app.state.completed; const servedFlights = flights.filter(f => servedIDs.includes(f.id)); const servedCount = servedFlights.length;
                   const servedArr = servedFlights.filter(f => f.type === 'ARR').length; const servedDep = servedFlights.filter(f => f.type === 'DEP').length;
                   const dateStr = app.state.baseDate ? new Date(app.state.baseDate).toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' }) : new Date().toLocaleDateString('tr-TR');
                   
                   const hStart = Math.floor(app.state.customStart/60); const hEnd = Math.floor((app.state.customEnd > 1440 ? app.state.customEnd - 1440 : app.state.customEnd)/60);
                   const rangeStr = app.state.shift === 'all' ? '' : `(${String(hStart).padStart(2,'0')}-${String(hEnd).padStart(2,'0')})`;
                   const shiftName = app.state.shift === 'all' ? 'TÜMÜ' : (app.state.shift === 'day' ? `GÜNDÜZ VARDİYASI` : `GECE VARDİYASI`);
                   const narrativeText = `Vardiyamızda ${plannedCount} adet uçuş gerçekleşmesi planlanmış olup, ${servedArr} adet geliş ve ${servedDep} adet gidiş olmak üzere toplam ${servedCount} adet uçuşa Follow-Me hizmeti verilmiştir.`;
                   
                   container.innerHTML = `<div style="width: 100%; height: 100%; background: #0f172a; padding: 40px; font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden;"><div style="position: absolute; top: -10%; right: -10%; width: 500px; height: 500px; background: rgba(59, 130, 246, 0.08); border-radius: 50%; filter: blur(80px);"></div><div style="position: absolute; bottom: -10%; left: -10%; width: 400px; height: 400px; background: rgba(16, 185, 129, 0.08); border-radius: 50%; filter: blur(80px);"></div><div style="display: flex; justify-content: space-between; align-items: flex-start; z-index: 10;"><div><div style="font-size: 14px; font-weight: 700; color: #64748b; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px;">Vardiya Sonu Raporu</div><div style="font-size: 48px; font-weight: 800; color: white; line-height: 1.1;">${shiftName}</div><div style="font-size: 24px; color: #94a3b8; margin-top: 8px;">${dateStr}</div></div><div style="width: 80px; height: 80px; background: linear-gradient(135deg, #2563eb, #4338ca); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px -5px rgba(37, 99, 235, 0.4);"><svg style="width: 40px; height: 40px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg></div></div><div style="display: flex; gap: 30px; margin-top: 40px; z-index: 10;"><div style="flex: 1; background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 30px;"><div style="font-size: 12px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 10px;">PLANLANAN UÇUŞ</div><div style="font-size: 56px; font-weight: 800; color: #94a3b8;">${plannedCount}</div></div><div style="flex: 1.5; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 24px; padding: 30px; position: relative; overflow: hidden;"><div style="font-size: 12px; font-weight: 800; color: #10b981; text-transform: uppercase; margin-bottom: 10px;">HİZMET VERİLEN TOPLAM</div><div style="font-size: 72px; font-weight: 800; color: white; line-height: 1;">${servedCount}</div><div style="display: flex; gap: 15px; margin-top: 20px;"><div style="background: rgba(16, 185, 129, 0.2); padding: 8px 16px; border-radius: 12px; display: flex; align-items: center; gap: 8px;"><svg style="width: 16px; height: 16px; color: #34d399;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg><span style="font-size: 16px; font-weight: 700; color: white;">${servedArr}</span><span style="font-size: 10px; font-weight: 700; color: #34d399; text-transform: uppercase;">GELİŞ</span></div><div style="background: rgba(245, 158, 11, 0.2); padding: 8px 16px; border-radius: 12px; display: flex; align-items: center; gap: 8px;"><svg style="width: 16px; height: 16px; color: #fbbf24;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg><span style="font-size: 16px; font-weight: 700; color: white;">${servedDep}</span><span style="font-size: 10px; font-weight: 700; color: #fbbf24; text-transform: uppercase;">GİDİŞ</span></div></div></div></div><div style="margin-top: auto; margin-bottom: 20px; z-index: 10;"><div style="font-size: 18px; color: #cbd5e1; font-weight: 500; line-height: 1.5; border-left: 4px solid #3b82f6; padding-left: 20px;">${narrativeText}</div></div><div style="display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 20px; z-index: 10;"><div style="font-family: monospace; font-size: 12px; color: #475569;">FOLLOW-ME OPS CENTER • SYSTEM REPORT</div><div style="font-size: 12px; font-weight: 700; color: #10b981; letter-spacing: 1px; text-transform: uppercase;">✔ Operasyon Başarıyla Tamamlandı</div></div></div>`;
                   try {
                       const canvas = await html2canvas(container, { backgroundColor: null, scale: 2 });
                       // DIRECT DOWNLOAD as requested
                       const link = document.createElement('a'); 
                       link.download = `Vardiya_Ozeti_${new Date().toISOString().slice(0,10)}.png`; 
                       link.href = canvas.toDataURL(); 
                       link.click();
                       document.body.removeChild(container);
                       app.ui.toast("Görsel İndirildi", "success");
                   } catch (err) { console.error("Canvas error:", err); document.body.removeChild(container); app.ui.toast("Görsel Hatası", "error"); }
                },
                smartReset: () => {
                    if(confirm("Mevcut uçuş verileri silinecek (Personel listeniz korunur). Emin misiniz?")) {
                        const currentStaff = app.state.staff;
                        app.state = {
                            flights: [],
                            shift: 'day', // Default reset
                            customStart: 480, customEnd: 1200, // Defaults
                            staff: currentStaff,
                            assignments: {},
                            gates: {},
                            overrides: {},
                            completed: [],
                            showCompleted: true,
                            filterMode: 'all',
                            baseDate: null
                        };
                        app.data.save(); app.ui.render(); app.ui.renderStaff(); app.ui.updateHeaderShiftLabel(); app.ui.toast("Sistem Temizlendi", "success");
                        const cm = document.getElementById('confirmModal'); if(cm) cm.classList.add('hidden');
                    }
                }
            },
            data: {
                save: () => { localStorage.setItem('fm_v16_2', JSON.stringify(app.state)); const el = document.getElementById('saveStatus'); if(el) { el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0', 2000); } },
                load: () => { const s = localStorage.getItem('fm_v16_2'); if(s) { try { app.state = {...app.state, ...JSON.parse(s)}; app.ui.render(); app.ui.updateHeaderShiftLabel(); } catch(e){} } },
                saveToJson: () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(app.state)], {type:'application/json'})); a.download = `backup_${Date.now()}.json`; a.click(); },
                loadFromJson: (input) => { const f = input.files[0]; if(!f) return; const r = new FileReader(); r.onload = (e) => { app.state = JSON.parse(e.target.result); app.ui.render(); app.ui.renderStaff(); app.ui.updateHeaderShiftLabel(); app.ui.toast("Yedek Yüklendi", "success"); }; r.readAsText(f); },
                reset: () => { app.ui.smartReset(); }
            }
        };
        window.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>