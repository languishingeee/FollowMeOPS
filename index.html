<!DOCTYPE html>
<html lang="tr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Follow-Me Ops | Pro v18.1</title>

    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#020617">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/723/723955.png">
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        hud: { bg: '#020617', panel: 'rgba(15, 23, 42, 0.8)' },
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif'],
                        display: ['"Rajdhani"', 'sans-serif']
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'flash-red': 'flashRed 1.5s infinite',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: {
                        'slide-up': {
                            '0%': { opacity: 0, transform: 'translateY(15px)' },
                            '100%': { opacity: 1, transform: 'translateY(0)' }
                        },
                        'flashRed': {
                            '0%, 100%': { borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.15)' },
                            '50%': { borderColor: 'transparent', backgroundColor: 'transparent' }
                        },
                        'shake': {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    },
                    screens: { 'xs': '375px' }
                }
            }
        }
    </script>

    <!-- Fonts & Icons - preconnect for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&family=Inter:wght@400;500;600;700&family=Rajdhani:wght@500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- App Styles - External for caching -->
    <link rel="stylesheet" href="./styles.css">

    <!-- Libraries - deferred for faster FCP -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
        defer></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" defer></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCPWMCjCp45PiTZ-VgskEszobpBzUFaOBk",
            authDomain: "followme-ops.firebaseapp.com",
            databaseURL: "https://followme-ops-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "followme-ops",
            storageBucket: "followme-ops.firebasestorage.app",
            messagingSenderId: "881822008",
            appId: "1:881822008:web:493ddb46ff7c56e2ea59cd"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const firebaseDB = firebase.database();
    </script>
</head>

<body class="flex flex-col h-screen text-gray-200 overflow-hidden bg-[#020617]">

    <div id="toastContainer"
        class="fixed top-24 right-4 left-4 md:left-auto md:right-6 z-[120] flex flex-col gap-3 pointer-events-none">
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 z-[200] bg-[#020617] flex flex-col items-center justify-center p-6">
        <div
            class="glass p-8 rounded-3xl w-full max-w-sm text-center border border-white/10 shadow-2xl relative overflow-hidden group">
            <div class="absolute inset-0 bg-blue-500/5 blur-3xl rounded-full scale-150 animate-pulse-slow"></div>
            <div class="relative z-10">
                <div
                    class="w-20 h-20 bg-gradient-to-br from-slate-800 to-black rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl border border-white/10 group-hover:border-blue-500/50 transition duration-500">
                    <i class="fa-solid fa-tower-broadcast text-4xl text-blue-500"></i>
                </div>
                <h2 class="text-2xl font-display font-bold text-white mb-1 tracking-wide">FOLLOW<span
                        class="text-blue-500">ME</span></h2>
                <p class="text-xs text-gray-400 mb-6 font-mono uppercase tracking-widest">Ops Center</p>

                <!-- Kullanıcı Girişi Butonu -->
                <button onclick="app.ui.loginAsUser()"
                    class="w-full py-4 mb-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-xl shadow-lg transition transform active:scale-95 text-sm tracking-widest uppercase flex items-center justify-center gap-3">
                    <i class="fa-solid fa-eye"></i> Kullanıcı Girişi
                </button>
                <p class="text-[10px] text-gray-500 mb-6">Sadece görüntüleme • Değişiklik yapılamaz</p>

                <div class="h-px bg-white/10 my-4"></div>
                <p class="text-[10px] text-gray-400 mb-3 uppercase tracking-wider">veya Admin olarak giriş yapın</p>

                <!-- Admin PIN Girişi -->
                <div class="relative">
                    <input type="password" id="pinInput" maxlength="4" placeholder="PIN" inputmode="numeric"
                        pattern="[0-9]*" autocomplete="one-time-code"
                        onkeydown="if(event.key === 'Enter') app.ui.loginAsAdmin()"
                        class="w-full bg-black/40 border border-white/10 rounded-xl py-3 text-center text-2xl font-mono text-white tracking-[0.5em] focus:border-amber-500 outline-none transition mb-3 placeholder-gray-700 shadow-inner">
                </div>
                <button onclick="app.ui.loginAsAdmin()"
                    class="w-full py-4 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-white font-bold rounded-xl shadow-lg shadow-amber-600/20 transition transform active:scale-95 text-sm tracking-widest uppercase flex items-center justify-center gap-3">
                    <i class="fa-solid fa-user-shield"></i> Admin Girişi
                </button>
                <p class="text-[10px] text-gray-500 mt-2">Tam yetki • Değişiklik yapabilir</p>
            </div>
        </div>
    </div>

    <!-- APP CONTENT -->
    <div id="appContent" class="flex flex-col h-full hidden opacity-0 transition-opacity duration-500">

        <header
            class="h-16 glass flex items-center justify-between px-4 md:px-8 z-50 shrink-0 border-b border-white/5 relative shadow-lg">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
                <div class="relative">
                    <div
                        class="absolute inset-0 bg-blue-500 blur-lg opacity-20 group-hover:opacity-40 transition duration-500">
                    </div>
                    <div
                        class="h-9 w-9 md:h-10 md:w-10 bg-gradient-to-br from-slate-800 to-slate-900 border border-white/10 rounded-xl flex items-center justify-center relative z-10 shadow-inner">
                        <i
                            class="fa-solid fa-tower-broadcast text-blue-400 text-lg transform group-hover:-translate-y-1 group-hover:translate-x-1 transition duration-500"></i>
                    </div>
                </div>
                <div>
                    <h1
                        class="font-display font-bold text-lg md:text-xl leading-none text-white tracking-wide group-hover:text-blue-400 transition">
                        FOLLOW<span class="text-blue-500">ME</span></h1>
                    <div class="text-[9px] md:text-[10px] text-gray-400 font-mono uppercase tracking-[0.3em] mt-0.5">Ops
                        Center</div>
                </div>
            </div>

            <div
                class="hidden md:flex flex-col items-center absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
                <div id="liveClock"
                    class="font-mono text-2xl md:text-3xl font-bold text-white tracking-tighter leading-none tabular-nums drop-shadow-md">
                    00:00:00</div>
                <div class="flex items-center gap-2 mt-1 opacity-80">
                    <span
                        class="text-[9px] md:text-[10px] font-bold text-gray-400 uppercase tracking-widest border-r border-white/10 pr-2"
                        id="liveDate">--.--.----</span>
                    <span
                        class="flex items-center gap-1 text-[9px] md:text-[10px] text-emerald-400 font-bold uppercase tracking-widest">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 animate-pulse"></span> CANLI
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-2 md:gap-3">
                <button onclick="app.ui.toggleMobileSearch()"
                    class="lg:hidden w-9 h-9 rounded-xl hover:bg-white/10 text-gray-300 flex items-center justify-center border border-transparent transition">
                    <i class="fa-solid fa-search"></i>
                </button>

                <div class="relative group hidden lg:block">
                    <i
                        class="fa-solid fa-search absolute left-4 top-2.5 text-gray-500 group-focus-within:text-blue-400 transition-colors text-xs"></i>
                    <input type="text" id="searchInput" placeholder="ARA..."
                        class="bg-slate-900/50 border border-white/10 text-white text-xs rounded-xl block w-40 lg:w-48 pl-11 pr-8 py-2 focus:border-blue-500/50 focus:w-56 transition-all duration-300 outline-none font-mono uppercase placeholder-gray-600 shadow-inner">
                    <button id="clearSearchBtn" onclick="app.ui.clearSearch()"
                        class="hidden absolute right-2 top-2 text-gray-500 hover:text-white p-1 rounded-full hover:bg-white/10 transition"><i
                            class="fa-solid fa-times text-[10px]"></i></button>
                </div>

                <div
                    class="flex items-center gap-1 bg-slate-900/40 p-1 rounded-xl border border-white/5 shadow-lg backdrop-blur-sm">
                    <button onclick="app.logic.undo()"
                        class="w-9 h-8 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white transition flex items-center justify-center"
                        title="Geri Al (Ctrl+Z)">
                        <i class="fa-solid fa-rotate-left text-sm"></i>
                    </button>
                    <button onclick="app.ui.showAddFlightModal()"
                        class="w-9 h-8 rounded-lg bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white shadow-lg shadow-emerald-600/30 hover:shadow-emerald-500/40 transition-all duration-200 flex items-center justify-center transform hover:scale-105 active:scale-95"
                        title="Uçuş Ekle">
                        <i class="fa-solid fa-plus text-sm"></i>
                    </button>
                    <div class="w-px h-5 bg-white/10 mx-0.5 hidden sm:block"></div>
                    <button onclick="app.logic.toggleUpdatedFilter()" id="btnUpdatedFilter"
                        class="px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase text-amber-400 hover:text-amber-300 hover:bg-amber-500/10 transition border border-transparent flex items-center gap-1.5"
                        title="Güncellenenleri Filtrele">
                        <i class="fa-solid fa-sync"></i> <span class="hidden xl:inline">GÜNCELLENMIŞ</span>
                    </button>
                    <button onclick="app.ui.toggleAnalysis()"
                        class="w-8 h-8 rounded-lg hover:bg-white/10 text-yellow-500 transition hidden sm:flex items-center justify-center"
                        title="Analiz"><i class="fa-solid fa-chart-pie text-sm"></i></button>
                    <button onclick="app.logic.generatePDF()"
                        class="w-8 h-8 rounded-lg hover:bg-white/10 text-red-500 transition hidden sm:flex items-center justify-center"
                        title="PDF"><i class="fa-solid fa-file-pdf text-sm"></i></button>
                    <button onclick="app.ui.toggleSettings()"
                        class="w-8 h-8 rounded-lg hover:bg-white/10 text-blue-400 transition hidden sm:flex items-center justify-center"
                        title="Ekip"><i class="fa-solid fa-users-gear text-sm"></i></button>
                    <button onclick="app.ui.toggleMenu()"
                        class="w-8 h-8 rounded-lg hover:bg-white/10 text-gray-300 transition flex items-center justify-center relative"
                        title="Ayarlar"><i class="fa-solid fa-gear text-sm"></i></button>
                </div>
            </div>
        </header>

        <div id="mobileSearch"
            class="hidden fixed top-14 left-0 right-0 bg-[#0f172a]/95 backdrop-blur-xl border-b border-white/10 p-3 z-[100] shadow-2xl">
            <div class="relative">
                <i class="fa-solid fa-search absolute left-4 top-3 text-gray-500"></i>
                <input type="text" id="searchInputMobile" placeholder="UÇUŞ ARA (VF1054...)"
                    class="w-full bg-slate-900 border border-white/10 rounded-xl py-2.5 pl-10 pr-10 text-white text-base focus:border-blue-500 outline-none font-mono uppercase">
                <button onclick="app.ui.toggleMobileSearch()"
                    class="absolute right-3 top-2.5 text-gray-400 hover:text-white p-1"><i
                        class="fa-solid fa-times"></i></button>
            </div>
        </div>

        <div id="mainMenu" onclick="if(event.target===this) this.classList.add('hidden')"
            class="hidden fixed inset-0 z-[90] bg-black/60 backdrop-blur-sm transition-opacity">
            <div
                class="absolute top-20 right-4 w-72 glass rounded-2xl shadow-2xl animate-slide-up origin-top-right overflow-hidden border border-white/10">
                <div class="p-2 space-y-1">
                    <div
                        class="px-4 py-2 text-[10px] font-bold text-gray-500 uppercase tracking-widest border-b border-white/5 mb-1">
                        Operasyon Menüsü</div>
                    <div class="sm:hidden space-y-1 pb-2 border-b border-white/5 mb-1">
                        <button onclick="app.ui.toggleAnalysis()"
                            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-yellow-500 hover:text-yellow-400 text-left"><i
                                class="fa-solid fa-chart-pie w-5"></i> Analiz</button>
                        <button onclick="app.logic.generatePDF()"
                            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-red-500 hover:text-red-400 text-left"><i
                                class="fa-solid fa-file-pdf w-5"></i> PDF Rapor</button>
                        <button onclick="app.ui.toggleSettings()"
                            class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-medium text-blue-400 hover:text-blue-300 text-left"><i
                                class="fa-solid fa-users-gear w-5"></i> Ekip Yönetimi</button>
                    </div>
                    <label
                        class="admin-only flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl cursor-pointer transition text-sm font-bold text-gray-300 hover:text-white group">
                        <div
                            class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500 group-hover:bg-emerald-500 group-hover:text-white transition">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>Excel Yükle <input type="file" id="fileInput" class="hidden" accept=".xlsx, .csv"
                            onchange="app.logic.handleFileUpload(event)">
                    </label>
                    <button onclick="app.logic.generateVisualReport()"
                        class="w-full flex items-center gap-3 px-4 py-3 hover:bg-white/5 rounded-xl transition text-sm font-bold text-gray-300 hover:text-white text-left group">
                        <div
                            class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-500 group-hover:bg-indigo-500 group-hover:text-white transition">
                            <i class="fa-solid fa-image"></i>
                        </div>Görsel Özet İndir
                    </button>
                    <div class="h-px bg-white/5 my-2"></div>
                    <button onclick="app.data.saveToJson()"
                        class="admin-only w-full flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-xl transition text-xs font-medium text-gray-400 hover:text-white text-left group"><i
                            class="fa-solid fa-download w-5 text-center"></i> Yedek Al</button>
                    <label
                        class="admin-only w-full flex items-center gap-3 px-4 py-2 hover:bg-white/5 rounded-xl transition text-xs font-medium text-gray-400 hover:text-white text-left group cursor-pointer"><i
                            class="fa-solid fa-upload w-5 text-center"></i> Yedek Yükle <input type="file"
                            onchange="app.data.loadFromJson(this)" class="hidden" accept=".json"></label>
                    <div class="h-px bg-white/5 my-2"></div>
                    <button onclick="app.ui.confirmReset()"
                        class="admin-only w-full flex items-center gap-3 px-4 py-3 hover:bg-red-500/10 rounded-xl transition text-xs font-bold text-red-500 text-left group">
                        <div
                            class="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500 group-hover:bg-red-500 group-hover:text-white transition">
                            <i class="fa-solid fa-trash"></i>
                        </div>Sistemi Sıfırla
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter & Shift Bar (Sticky) -->
        <div
            class="bg-[#020617]/95 backdrop-blur border-b border-white/5 p-3 flex justify-between items-center gap-3 sticky top-0 z-40 shadow-xl overflow-x-auto no-scrollbar">
            <!-- Shift Info / Trigger -->
            <div class="flex items-center gap-2 cursor-pointer group shrink-0" onclick="app.ui.showShiftConfig()">
                <div
                    class="w-8 h-8 rounded-lg bg-blue-600/10 border border-blue-600/30 flex items-center justify-center text-blue-500 group-hover:bg-blue-600 group-hover:text-white transition">
                    <i class="fa-solid fa-sliders"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">AKTİF VARDİYA</span>
                    <span id="activeShiftLabel"
                        class="text-xs font-bold text-white uppercase tracking-wide group-hover:text-blue-400 transition">VARDİYA
                        YOK</span>
                </div>
            </div>

            <!-- View Filters -->
            <div class="flex items-center gap-2 w-full md:w-auto overflow-x-auto no-scrollbar pb-1 md:pb-0">
                <button onclick="app.ui.setFilter('all')" id="filter-all"
                    class="flex-1 md:flex-none px-4 py-1.5 rounded-xl text-[10px] font-bold uppercase transition text-white bg-white/10 border border-white/5 whitespace-nowrap">Tümü</button>
                <button onclick="app.ui.setFilter('focus')" id="filter-focus"
                    class="flex-1 md:flex-none px-4 py-1.5 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 border border-transparent whitespace-nowrap">Odak</button>
                <button onclick="app.ui.setFilter('completed')" id="filter-completed"
                    class="flex-1 md:flex-none px-4 py-1.5 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 border border-transparent whitespace-nowrap">Biten</button>
            </div>
        </div>

        <main onclick="app.ui.closeMenus(event)"
            class="flex-1 overflow-y-auto p-2 md:p-6 lg:px-12 relative custom-scroll scroll-smooth">
            <div id="emptyState"
                class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
                <div
                    class="glass p-8 md:p-10 rounded-3xl border border-white/10 text-center max-w-sm pointer-events-auto shadow-2xl relative overflow-hidden mx-4">
                    <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-50"></div>
                    <div
                        class="w-20 h-20 bg-blue-500/10 rounded-2xl flex items-center justify-center mx-auto mb-6 ring-1 ring-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.15)] relative z-10">
                        <i class="fa-solid fa-tower-broadcast text-4xl text-blue-500 animate-pulse"></i>
                    </div>
                    <h2 class="text-xl md:text-2xl font-display font-bold text-white mb-2 tracking-wide relative z-10">
                        Vardiya Bekleniyor</h2>
                    <p class="text-xs text-gray-400 mb-8 font-medium leading-relaxed relative z-10">Günlük operasyon
                        listesini yükleyerek<br>sistemi aktif hale getirin.</p>
                    <label
                        class="cursor-pointer bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-8 rounded-xl transition flex items-center justify-center gap-2 text-sm shadow-xl shadow-blue-600/20 active:scale-95 relative z-10"><i
                            class="fa-solid fa-cloud-arrow-up"></i><span>DOSYA SEÇ</span><input type="file"
                            onchange="app.logic.handleFileUpload(event)" class="hidden" accept=".xlsx, .csv"></label>
                </div>
            </div>
            <div id="flightGrid"
                class="grid grid-cols-1 xl:grid-cols-2 gap-3 md:gap-4 pb-32 relative z-10 max-w-8xl mx-auto"></div>
        </main>

        <footer
            class="h-14 glass border-t border-white/5 flex items-center justify-between px-4 md:px-6 text-[10px] font-bold text-gray-500 uppercase tracking-widest z-50">
            <div class="flex gap-4 md:gap-6 overflow-x-auto no-scrollbar w-full items-center">
                <span class="flex items-center gap-2 whitespace-nowrap"><i
                        class="fa-solid fa-list text-gray-400"></i><span class="hidden sm:inline">Toplam:</span><span
                        id="statTotal" class="text-white">0</span></span>
                <span class="flex items-center gap-2 whitespace-nowrap"><i
                        class="fa-solid fa-eye text-blue-500"></i><span class="hidden sm:inline">Odak:</span><span
                        id="statFocus" class="text-blue-400">0</span></span>
                <span class="flex items-center gap-2 whitespace-nowrap"><i
                        class="fa-solid fa-check-circle text-emerald-500"></i><span
                        class="hidden sm:inline">Biten:</span><span id="statDone"
                        class="text-emerald-400">0</span></span>
                <span class="flex items-center gap-2 whitespace-nowrap"><i
                        class="fa-solid fa-user-astronaut text-purple-500"></i><span
                        class="hidden sm:inline">Atanan:</span><span id="statAssigned"
                        class="text-purple-400">0</span></span>
            </div>
            <div id="saveStatus"
                class="opacity-0 transition-opacity text-emerald-500 flex items-center gap-2 font-bold tracking-wider hidden md:flex">
                <i class="fa-solid fa-floppy-disk animate-bounce"></i> <span>KAYITLI</span>
            </div>
        </footer>

        <!-- MOBILE BOTTOM NAVIGATION - Only visible on mobile -->
        <nav id="mobileBottomNav"
            class="md:hidden fixed bottom-0 left-0 right-0 z-[60] glass border-t border-white/10 backdrop-blur-xl">
            <div class="flex items-center justify-around py-2 px-1">
                <!-- Excel Upload -->
                <label
                    class="admin-only flex flex-col items-center gap-1 p-2 rounded-xl active:bg-white/10 transition cursor-pointer">
                    <div class="w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center">
                        <i class="fa-solid fa-file-excel text-emerald-500 text-lg"></i>
                    </div>
                    <span class="text-[9px] text-gray-400 font-bold uppercase">Excel</span>
                    <input type="file" class="hidden" accept=".xlsx, .csv" onchange="app.logic.handleFileUpload(event)">
                </label>

                <!-- Search -->
                <button onclick="app.ui.toggleMobileSearch()"
                    class="flex flex-col items-center gap-1 p-2 rounded-xl active:bg-white/10 transition">
                    <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center">
                        <i class="fa-solid fa-search text-blue-400 text-lg"></i>
                    </div>
                    <span class="text-[9px] text-blue-400 font-bold uppercase">Ara</span>
                </button>

                <!-- Menu -->
                <button onclick="app.ui.toggleMenu()"
                    class="flex flex-col items-center gap-1 p-2 rounded-xl active:bg-white/10 transition">
                    <div class="w-10 h-10 rounded-full bg-slate-700/50 flex items-center justify-center">
                        <i class="fa-solid fa-bars text-gray-300 text-lg"></i>
                    </div>
                    <span class="text-[9px] text-gray-400 font-bold uppercase">Menü</span>
                </button>
            </div>
        </nav>
        <!-- MODALS -->

        <!-- Shift Config Modal -->
        <div id="shiftConfigModal" onclick="if(event.target===this) this.classList.add('hidden')"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[110] flex items-center justify-center p-4 transition-opacity cursor-pointer">
            <div
                class="glass bg-slate-900 rounded-3xl w-full max-w-md shadow-2xl overflow-hidden animate-slide-up border border-white/10">
                <div class="p-6 text-center border-b border-white/5">
                    <div class="w-16 h-16 bg-blue-600/10 rounded-2xl flex items-center justify-center mx-auto mb-4"><i
                            class="fa-solid fa-calendar-check text-3xl text-blue-500"></i></div>
                    <h3 class="font-display font-bold text-2xl text-white">Vardiya Planlama</h3>
                    <p class="text-xs text-gray-400 mt-2">Vardiya türünü ve odak saatlerini belirleyin.</p>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Shift Type Selection -->
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="app.ui.selectShiftType('day')" id="sc-btn-day"
                            class="shift-btn active py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Gündüz</button>
                        <button onclick="app.ui.selectShiftType('night')" id="sc-btn-night"
                            class="shift-btn py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Gece</button>
                        <button onclick="app.ui.selectShiftType('all')" id="sc-btn-all"
                            class="shift-btn py-3 rounded-xl text-xs font-bold uppercase bg-white/5 hover:bg-white/10 text-gray-400">Tümü</button>
                    </div>

                    <!-- Custom Time Range -->
                    <div id="customTimeRange" class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Odak Saat
                            Aralığı</label>
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-black/30 rounded-xl border border-white/10 px-4 py-2 flex flex-col">
                                <span class="text-[9px] text-gray-500 font-bold mb-1">BAŞLANGIÇ</span>
                                <input type="time" id="sc-start"
                                    class="bg-transparent text-white font-mono font-bold text-lg outline-none"
                                    value="08:00">
                            </div>
                            <div class="text-gray-600"><i class="fa-solid fa-arrow-right"></i></div>
                            <div class="flex-1 bg-black/30 rounded-xl border border-white/10 px-4 py-2 flex flex-col">
                                <span class="text-[9px] text-gray-500 font-bold mb-1">BİTİŞ</span>
                                <input type="time" id="sc-end"
                                    class="bg-transparent text-white font-mono font-bold text-lg outline-none"
                                    value="20:00">
                            </div>
                        </div>
                        <p class="text-[10px] text-gray-500 italic mt-2 text-center">* Gece vardiyasında bitiş saati
                            ertesi günü temsil eder.</p>
                    </div>

                    <button onclick="app.logic.applyShiftConfig()"
                        class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-600/30 transition transform active:scale-95 uppercase tracking-wide text-sm">
                        Operasyonu Başlat
                    </button>
                </div>
            </div>
        </div>

        <!-- Analysis Modal -->
        <div id="analysisModal" onclick="if(event.target === this) app.ui.toggleAnalysis()"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4 transition-opacity">
            <div
                class="glass bg-slate-900 rounded-3xl w-full max-w-5xl shadow-2xl overflow-hidden animate-slide-up flex flex-col max-h-[90vh] border border-white/10">
                <div class="p-4 md:p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-yellow-500/10 border border-yellow-500/20 flex items-center justify-center text-yellow-500">
                            <i class="fa-solid fa-chart-line text-xl"></i>
                        </div>
                        <h3 class="font-display font-bold text-2xl text-white tracking-wide">Analiz</h3>
                    </div>
                    <button onclick="app.ui.toggleAnalysis()"
                        class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="analysisContent" class="p-4 md:p-8 overflow-y-auto custom-scroll"></div>
            </div>
        </div>

        <!-- Staff Modal -->
        <div id="staffModal" onclick="if(event.target === this) app.ui.toggleSettings()"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
            <div
                class="glass bg-slate-900 w-full max-w-md rounded-3xl overflow-hidden shadow-2xl animate-slide-up border border-white/10">
                <div class="p-5 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <h3
                        class="font-display font-bold text-lg text-white uppercase tracking-wide flex items-center gap-3">
                        <i class="fa-solid fa-users text-blue-500"></i> Ekip Yönetimi
                    </h3>
                    <button onclick="app.ui.toggleSettings()" class="text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times text-lg"></i></button>
                </div>
                <div class="p-5">
                    <div class="flex gap-3 mb-5">
                        <input type="text" id="newStaffName" placeholder="YENİ İSİM"
                            class="flex-1 bg-slate-800 border border-white/10 rounded-xl px-4 py-2 text-base md:text-sm text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                        <button onclick="app.logic.addStaff()"
                            class="bg-blue-600 hover:bg-blue-500 text-white px-4 rounded-xl font-bold shadow-lg shadow-blue-600/30 transition transform active:scale-95"><i
                                class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="staffList" class="max-h-64 overflow-y-auto space-y-2 pr-1 custom-scroll"></div>
                </div>
            </div>
        </div>

        <!-- Reset Confirm Modal -->
        <div id="confirmModal"
            onclick="if(event.target === this) document.getElementById('confirmModal').classList.add('hidden')"
            class="hidden fixed inset-0 bg-black/95 backdrop-blur-xl z-[110] flex items-center justify-center p-4">
            <div
                class="glass p-8 rounded-3xl text-center max-w-sm w-full animate-slide-up border border-red-500/30 shadow-[0_0_80px_rgba(239,68,68,0.2)] bg-[#0f172a]">
                <div
                    class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 ring-1 ring-red-500/40">
                    <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
                </div>
                <h3 class="text-xl font-display font-bold text-white mb-2">Emin misiniz?</h3>
                <p class="text-xs text-gray-400 mb-8 font-medium leading-relaxed">Tüm veriler silinecek.</p>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('confirmModal').classList.add('hidden')"
                        class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-gray-300 rounded-xl font-bold text-xs uppercase transition tracking-wider border border-white/5">Vazgeç</button>
                    <button onclick="app.ui.smartReset()"
                        class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white rounded-xl font-bold text-xs uppercase shadow-lg shadow-red-600/30 transition tracking-wider transform hover:scale-[1.02]">TEMİZLE</button>
                </div>
            </div>
        </div>
        <!-- Add Flight Modal -->
        <div id="addFlightModal" onclick="if(event.target === this) app.ui.toggleAddFlightModal()"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
            <div
                class="glass bg-slate-900 rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden animate-slide-up border border-white/10">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-500">
                            <i class="fa-solid fa-plane-circle-plus text-xl"></i>
                        </div>
                        <h3 class="font-display font-bold text-2xl text-white tracking-wide">Manuel Uçuş Ekle</h3>
                    </div>
                    <button onclick="app.ui.toggleAddFlightModal()"
                        class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scroll">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Uçuş
                                Tipi</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="app.ui.selectFlightType('ARR')" id="af-type-arr"
                                    class="py-3 rounded-xl text-xs font-bold uppercase bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500 hover:text-white transition"><i
                                        class="fa-solid fa-plane-arrival mr-1"></i> Geliş</button>
                                <button onclick="app.ui.selectFlightType('DEP')" id="af-type-dep"
                                    class="py-3 rounded-xl text-xs font-bold uppercase bg-white/5 text-gray-400 border border-white/10 hover:bg-white/10 transition"><i
                                        class="fa-solid fa-plane-departure mr-1"></i> Gidiş</button>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Saat</label>
                            <input type="time" id="af-time"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-mono font-bold shadow-inner">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Uçuş
                            Numarası</label>
                        <input type="text" id="af-flightno" placeholder="TK1234"
                            class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Havayolu</label>
                        <input type="text" id="af-airline" placeholder="TURKISH AIRLINES"
                            class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Rota</label>
                            <input type="text" id="af-route" placeholder="ISTANBUL"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Kapı
                                (Opsiyonel)</label>
                            <input type="text" id="af-gate" placeholder="12"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-mono font-bold shadow-inner placeholder-gray-600">
                        </div>
                    </div>
                    <button onclick="app.logic.addManualFlight()"
                        class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-600/30 transition transform active:scale-95 uppercase tracking-wide text-sm flex items-center justify-center gap-2"><i
                            class="fa-solid fa-plus"></i> Uçuş Ekle</button>
                </div>
            </div>
        </div>

        <!-- Add Flight Modal -->
        <div id="addFlightModal" onclick="if(event.target === this) app.ui.toggleAddFlightModal()"
            class="hidden fixed inset-0 bg-black/90 backdrop-blur-md z-[100] flex items-center justify-center p-4">
            <div
                class="glass bg-slate-900 rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden animate-slide-up border border-white/10">
                <div class="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
                    <div class="flex items-center gap-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-500">
                            <i class="fa-solid fa-plane-circle-plus text-xl"></i>
                        </div>
                        <h3 class="font-display font-bold text-2xl text-white tracking-wide">Manuel Uçuş Ekle</h3>
                    </div>
                    <button onclick="app.ui.toggleAddFlightModal()"
                        class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center transition text-gray-400 hover:text-white"><i
                            class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto custom-scroll">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Uçuş
                                Tipi</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="app.ui.selectFlightType('ARR')" id="af-type-arr"
                                    class="py-3 rounded-xl text-xs font-bold uppercase bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 hover:bg-emerald-500 hover:text-white transition"><i
                                        class="fa-solid fa-plane-arrival mr-1"></i> Geliş</button>
                                <button onclick="app.ui.selectFlightType('DEP')" id="af-type-dep"
                                    class="py-3 rounded-xl text-xs font-bold uppercase bg-white/5 text-gray-400 border border-white/10 hover:bg-white/10 transition"><i
                                        class="fa-solid fa-plane-departure mr-1"></i> Gidiş</button>
                            </div>
                        </div>
                        <div>
                            <label
                                class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Saat</label>
                            <input type="time" id="af-time"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-mono font-bold shadow-inner">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Uçuş
                            Numarası</label>
                        <input type="text" id="af-flightno" placeholder="TK1234"
                            class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                    </div>
                    <div>
                        <label
                            class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Havayolu</label>
                        <input type="text" id="af-airline" placeholder="TURKISH AIRLINES"
                            class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Rota</label>
                            <input type="text" id="af-route" placeholder="ISTANBUL"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-bold uppercase shadow-inner placeholder-gray-600">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-2">Kapı
                                (Opsiyonel)</label>
                            <input type="text" id="af-gate" placeholder="12"
                                class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-3 text-base text-white focus:border-blue-500 outline-none font-mono font-bold shadow-inner placeholder-gray-600">
                        </div>
                    </div>
                    <button onclick="app.logic.addManualFlight()"
                        class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg shadow-emerald-600/30 transition transform active:scale-95 uppercase tracking-wide text-sm flex items-center justify-center gap-2"><i
                            class="fa-solid fa-plus"></i> Uçuş Ekle</button>
                </div>
            </div>
        </div>

        <!-- Excel Merge Modal -->
        <div id="excelMergeModal"
            class="hidden fixed inset-0 z-[150] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-slate-900/95 rounded-2xl border border-white/10 shadow-2xl p-6 max-w-md w-full">
                <div class="text-center mb-6">
                    <div class="w-14 h-14 bg-amber-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-file-excel text-2xl text-amber-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Mevcut Veri Tespit Edildi</h3>
                    <p class="text-sm text-gray-400">Zaten yüklenmiş uçuş verisi var. Ne yapmak istersiniz?</p>
                </div>
                <div class="space-y-3">
                    <button onclick="app.logic.mergeExcelData()"
                        class="w-full py-3 px-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 transition transform active:scale-95 shadow-lg">
                        <i class="fa-solid fa-code-merge"></i>
                        <span>Güncelle / Birleştir</span>
                    </button>
                    <p class="text-[10px] text-gray-500 text-center -mt-1 mb-2">Sadece değişen verileri günceller, aynı
                        kalan uçuşlara dokunmaz</p>
                    <button onclick="app.logic.replaceWithNewExcel()"
                        class="w-full py-3 px-4 bg-red-600/80 hover:bg-red-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 transition transform active:scale-95">
                        <i class="fa-solid fa-rotate"></i>
                        <span>Tamamen Değiştir</span>
                    </button>
                    <p class="text-[10px] text-gray-500 text-center -mt-1 mb-2">Mevcut tüm veriyi siler, yeni Excel ile
                        başlar</p>
                    <button
                        onclick="document.getElementById('excelMergeModal').classList.add('hidden'); app.logic.pendingExcelData = null;"
                        class="w-full py-2 px-4 bg-white/5 hover:bg-white/10 text-gray-400 font-bold rounded-xl transition">
                        İptal
                    </button>
                </div>
            </div>
        </div>

        <datalist id="staffOptions"></datalist>

        <script>
            // ========== CONSTANTS ==========
            const CONSTANTS = {
                STORAGE_KEY: 'fm_v18_1',
                DEFAULT_PIN: '1105',
                DEBOUNCE_DELAY: 300,
                AUTO_SAVE_INTERVAL: 15000,
                MIN_SEARCH_LENGTH: 0,
                BREAK_GAP_THRESHOLD: 45,
                PDF_BUFFER_MINUTES: 20
            };


            const app = {
                isAdmin: false, // Admin mi yoksa kullanıcı mı - Firebase'e GİTMEYECEK
                state: {
                    flights: [],
                    shift: 'day',
                    customStart: 480, // 08:00
                    customEnd: 1200, // 20:00
                    staff: ['AHMET Y.', 'MEHMET K.', 'AYŞE D.', 'FATMA S.', 'CAN B.'],
                    assignments: {}, gates: {}, overrides: {}, completed: [], delayed: {}, timeChanges: {},
                    showCompleted: true, filterMode: 'all', baseDate: null,
                    history: [], // Son 10 işlem için geri alma
                    flightHistory: {}, // Uçuş değişiklik geçmişi
                    showUpdatedOnly: false // Güncellenmiş filtresi
                },
                init: () => {
                    app.data.load(); app.ui.startClock(); app.ui.renderStaff(); app.ui.updateShiftUI(); app.ui.setFilter(app.state.filterMode); app.ui.updateCompletedBtn(); app.ui.updateHeaderShiftLabel();
                    const updateDate = () => { document.getElementById('liveDate').innerText = new Date().toLocaleDateString('tr-TR'); };
                    updateDate(); setInterval(updateDate, 60000);
                    const searchInput = document.getElementById('searchInput'); const searchInputMobile = document.getElementById('searchInputMobile');
                    let searchTimeout; const handleSearch = (e) => { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { const val = e.target.value; if (e.target.id === 'searchInput') { document.getElementById('clearSearchBtn').classList.toggle('hidden', val.length === 0); if (searchInputMobile) searchInputMobile.value = val; } else { if (searchInput) searchInput.value = val; document.getElementById('clearSearchBtn').classList.toggle('hidden', val.length === 0); } app.ui.render(); }, 150); };
                    if (searchInput) searchInput.addEventListener('input', handleSearch); if (searchInputMobile) searchInputMobile.addEventListener('input', handleSearch);

                    // Show Login Screen if not logged in this session
                    if (!sessionStorage.getItem('isLoggedIn')) {
                        document.getElementById('loginScreen').classList.remove('hidden');
                    } else {
                        // Session'dan admin durumunu yükle
                        app.isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                        document.getElementById('appContent').classList.remove('hidden');
                        document.getElementById('appContent').classList.remove('opacity-0');
                        document.getElementById('loginScreen').classList.add('hidden');
                        // UI'ı güncelle (admin/kullanıcı göstergesi)
                        setTimeout(() => app.ui.updateAdminUI(), 100);
                    }

                    // Ctrl+Z kısayolu
                    document.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 'z') { e.preventDefault(); app.logic.undo(); }
                    });

                    setInterval(app.data.save, CONSTANTS.AUTO_SAVE_INTERVAL);
                },
                ui: {
                    // Kullanıcı girişi (sadece okuma)
                    loginAsUser: () => {
                        app.isAdmin = false;
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('isAdmin', 'false');
                        app.ui.completeLogin();
                        app.ui.toast('Kullanıcı olarak giriş yapıldı', 'info');
                    },

                    // Admin girişi (tam yetki)
                    loginAsAdmin: () => {
                        const pin = document.getElementById('pinInput').value;
                        if (pin === CONSTANTS.DEFAULT_PIN) {
                            app.isAdmin = true;
                            sessionStorage.setItem('isLoggedIn', 'true');
                            sessionStorage.setItem('isAdmin', 'true');
                            app.ui.completeLogin();
                            app.ui.toast('Admin olarak giriş yapıldı', 'success');
                        } else {
                            const box = document.querySelector('#loginScreen .glass');
                            box.classList.add('animate-shake');
                            document.getElementById('pinInput').value = '';
                            setTimeout(() => box.classList.remove('animate-shake'), 500);
                            app.ui.toast('Hatalı PIN', 'error');
                        }
                    },

                    // Giriş tamamlama animasyonu
                    completeLogin: () => {
                        const login = document.getElementById('loginScreen');
                        login.style.opacity = '0';
                        login.style.transition = 'opacity 0.5s';
                        setTimeout(() => {
                            login.classList.add('hidden');
                            const content = document.getElementById('appContent');
                            content.classList.remove('hidden');
                            setTimeout(() => content.classList.remove('opacity-0'), 50);
                            app.ui.updateAdminUI();
                            app.ui.render(); // Kartları yeniden çiz (admin kontrolü ile)
                        }, 500);
                    },

                    // Admin UI güncellemesi (düzenleme kontrollerini gizle/göster)
                    updateAdminUI: () => {
                        const isAdmin = app.isAdmin;
                        // Admin değilse düzenleme butonlarını gizle
                        document.querySelectorAll('.admin-only').forEach(el => {
                            el.style.display = isAdmin ? '' : 'none';
                        });
                        // Header'a rol göstergesi ekle
                        const existingBadge = document.getElementById('roleBadge');
                        if (existingBadge) existingBadge.remove();
                        const header = document.querySelector('header');
                        if (header) {
                            const badge = document.createElement('div');
                            badge.id = 'roleBadge';
                            badge.className = `fixed top-16 right-4 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider z-[80] ${isAdmin ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : 'bg-slate-500/20 text-slate-400 border border-slate-500/30'}`;
                            badge.innerHTML = isAdmin ? '<i class="fa-solid fa-user-shield mr-1"></i> ADMIN' : '<i class="fa-solid fa-eye mr-1"></i> KULLANICI';
                            document.body.appendChild(badge);
                        }
                    },

                    // Admin kontrolü - düzenleme işlemlerinden önce çağrılır
                    requireAdmin: (action) => {
                        if (!app.state.isAdmin) {
                            app.ui.toast('Bu işlem için admin yetkisi gerekli', 'error');
                            return false;
                        }
                        return true;
                    },

                    // Eski checkPin uyumluluk için
                    checkPin: () => { app.ui.loginAsAdmin(); },
                    toast: (msg, type = 'info') => {
                        const c = document.getElementById('toastContainer'); const d = document.createElement('div');
                        const cls = { success: 'border-emerald-500 bg-emerald-500/20 shadow-emerald-500/10 text-emerald-200', error: 'border-red-500 bg-red-500/20 shadow-red-500/10 text-red-200', info: 'border-blue-500 bg-blue-500/20 shadow-blue-500/10 text-blue-200' };
                        d.className = `p-3 rounded-xl border-l-4 backdrop-blur-xl shadow-2xl text-xs font-bold text-white animate-slide-in pointer-events-auto flex items-center gap-3 uppercase tracking-wide ${cls[type] || cls.info}`;
                        d.innerHTML = `<span>${msg}</span>`; c.appendChild(d); setTimeout(() => { d.style.opacity = '0'; d.style.transform = 'translateY(-10px)'; setTimeout(() => d.remove(), 300); }, 3000);
                    },
                    startClock: () => { setInterval(() => { const now = new Date(); document.getElementById('liveClock').innerText = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }, 1000); },
                    clearSearch: () => { const el = document.getElementById('searchInput'); const elMob = document.getElementById('searchInputMobile'); if (el) el.value = ''; if (elMob) elMob.value = ''; app.ui.render(); },
                    toggleMobileSearch: () => { const el = document.getElementById('mobileSearch'); el.classList.toggle('hidden'); if (!el.classList.contains('hidden')) { setTimeout(() => document.getElementById('searchInputMobile').focus(), 100); } },
                    setFilter: (mode) => {
                        app.state.filterMode = mode;
                        ['all', 'focus', 'completed'].forEach(m => {
                            const btn = document.getElementById(`filter-${m}`); if (!btn) return;
                            if (m === mode) { btn.className = "px-4 md:px-6 py-1.5 md:py-2 rounded-xl text-[10px] font-bold uppercase transition text-white bg-blue-600 shadow-lg shadow-blue-600/30 border border-blue-500/50 transform scale-105"; }
                            else { btn.className = "px-4 md:px-6 py-1.5 md:py-2 rounded-xl text-[10px] font-bold uppercase transition text-gray-400 hover:text-white border border-transparent hover:bg-white/5"; }
                        }); app.ui.render();
                    },
                    toggleMenu: () => { const m = document.getElementById('mainMenu'); if (m) m.classList.toggle('hidden'); },
                    closeMenus: (e) => { if (!e.target.closest('button') && !e.target.closest('#mainMenu') && !e.target.closest('#mobileSearch')) { document.getElementById('mainMenu').classList.add('hidden'); } },
                    toggleSettings: () => { const m = document.getElementById('staffModal'); if (m) m.classList.toggle('hidden'); },
                    toggleAnalysis: () => { const m = document.getElementById('analysisModal'); m.classList.toggle('hidden'); if (!m.classList.contains('hidden')) app.logic.analyze(); },
                    confirmReset: () => { app.ui.toggleMenu(); document.getElementById('confirmModal').classList.remove('hidden'); },
                    toggleCompleted: () => { app.state.showCompleted = !app.state.showCompleted; app.ui.updateCompletedBtn(); app.ui.render(); },
                    updateCompletedBtn: () => { const lbl = document.getElementById('lblCompleted'); if (lbl) lbl.innerText = app.state.showCompleted ? "GİZLE" : "GÖSTER"; },

                    showShiftConfig: () => {
                        document.getElementById('shiftConfigModal').classList.remove('hidden');
                        app.ui.selectShiftType(app.state.shift || 'day');
                    },

                    selectShiftType: (type) => {
                        ['day', 'night', 'all'].forEach(t => {
                            const btn = document.getElementById(`sc-btn-${t}`);
                            if (t === type) { btn.classList.add('active'); btn.classList.remove('bg-white/5', 'text-gray-400'); }
                            else { btn.classList.remove('active'); btn.classList.add('bg-white/5', 'text-gray-400'); }
                        });
                        const startInp = document.getElementById('sc-start'); const endInp = document.getElementById('sc-end');
                        if (type === 'day') { startInp.value = "08:00"; endInp.value = "20:00"; }
                        else if (type === 'night') { startInp.value = "20:00"; endInp.value = "08:00"; }
                        else { startInp.value = "00:00"; endInp.value = "23:59"; }
                    },

                    // Mobile quick complete - completes first incomplete flight in focus
                    quickCompleteAction: () => {
                        const now = new Date();
                        const focusFlights = app.state.flights.filter(f => {
                            const d = new Date(f.timestamp);
                            const m = d.getHours() * 60 + d.getMinutes() + (f.isNextDay ? 1440 : 0);
                            if (app.state.shift === 'all') return true;
                            return (m >= app.state.customStart && m <= app.state.customEnd);
                        }).filter(f => !f.isBuffer && !app.state.completed.includes(f.id))
                            .sort((a, b) => a.timestamp - b.timestamp);

                        if (focusFlights.length === 0) {
                            app.ui.toast("Tamamlanacak uçuş yok", "info");
                            return;
                        }

                        // Complete the first one
                        const nextFlight = focusFlights[0];
                        app.logic.toggleComplete(nextFlight.id);
                        app.ui.toast(`${nextFlight.flightNo} tamamlandı`, "success");
                    },


                    showExcelMergeModal: () => {
                        const modal = document.getElementById('excelMergeModal');
                        if (modal) modal.classList.remove('hidden');
                    },

                    updateHeaderShiftLabel: () => {
                        const label = document.getElementById('activeShiftLabel'); if (!label) return;
                        const s = app.state.shift;
                        const minsToTime = (m) => { let h = Math.floor(m / 60); let mn = m % 60; if (h >= 24) h -= 24; return `${String(h).padStart(2, '0')}:${String(mn).padStart(2, '0')}`; };
                        let rangeStr = ""; if (s === 'all') rangeStr = "TÜM GÜN"; else { rangeStr = `${minsToTime(app.state.customStart)} - ${minsToTime(app.state.customEnd - (app.state.customEnd > 1440 ? 1440 : 0))}`; }
                        const name = s === 'day' ? 'GÜNDÜZ' : (s === 'night' ? 'GECE' : 'TÜMÜ');
                        label.innerText = `${name} (${rangeStr})`;
                    },

                    updateShiftUI: () => {
                        // This function is kept for compatibility but main update happens via label now
                    },
                    showAddFlightModal: () => {
                        document.getElementById('addFlightModal').classList.remove('hidden');
                        document.getElementById('af-time').value = new Date().toTimeString().slice(0, 5);
                        app.ui.selectFlightType('ARR');
                    },
                    toggleAddFlightModal: () => {
                        const modal = document.getElementById('addFlightModal');
                        modal.classList.toggle('hidden');
                    },
                    selectFlightType: (type) => {
                        const arrBtn = document.getElementById('af-type-arr');
                        const depBtn = document.getElementById('af-type-dep');
                        if (type === 'ARR') {
                            arrBtn.className = 'py-3 rounded-xl text-xs font-bold uppercase bg-emerald-500 text-white border border-emerald-500/30 transition';
                            depBtn.className = 'py-3 rounded-xl text-xs font-bold uppercase bg-white/5 text-gray-400 border border-white/10 hover:bg-white/10 transition';
                        } else {
                            arrBtn.className = 'py-3 rounded-xl text-xs font-bold uppercase bg-white/5 text-gray-400 border border-white/10 hover:bg-white/10 transition';
                            depBtn.className = 'py-3 rounded-xl text-xs font-bold uppercase bg-amber-500 text-white border border-amber-500/30 transition';
                        }
                    },

                    // Uçuş değişiklik geçmişini göster
                    showFlightHistory: (id) => {
                        const history = app.state.flightHistory[id];
                        if (!history || history.length === 0) {
                            app.ui.toast("Bu uçuş için geçmiş bulunamadı", "info");
                            return;
                        }
                        const flight = app.state.flights.find(f => f.id === id);
                        const flightNo = flight ? flight.flightNo : id;
                        const isArr = flight ? flight.type === 'ARR' : true;

                        // Geçmiş satırlarını oluştur
                        const historyHtml = history.slice().reverse().map((h, i) => {
                            const time = new Date(h.timestamp).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                            const icon = h.field === 'Saat' ? 'fa-clock' : 'fa-door-open';
                            const color = h.field === 'Saat' ? 'text-cyan-400' : 'text-amber-400';
                            return `<div class="flex items-center gap-3 bg-black/20 p-3 rounded-lg border-l-2 ${h.field === 'Saat' ? 'border-cyan-500' : 'border-amber-500'}">
                                <div class="text-xs text-gray-500 font-mono w-12">${time}</div>
                                <i class="fa-solid ${icon} ${color} text-sm"></i>
                                <div class="flex-1">
                                    <span class="text-gray-400 text-sm">${h.field}:</span>
                                    <span class="text-red-400 line-through text-sm ml-1">${h.oldValue}</span>
                                    <span class="text-gray-500 mx-1">→</span>
                                    <span class="text-emerald-400 font-bold text-sm">${h.newValue}</span>
                                </div>
                            </div>`;
                        }).join('');

                        // Modal HTML
                        const modalHtml = `
                        <div id="historyModal" onclick="if(event.target === this) this.remove()" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[110] flex items-center justify-center p-4 animate-fade-in">
                            <div class="glass bg-slate-900 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden animate-slide-up border border-white/10">
                                <div class="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r ${isArr ? 'from-emerald-500/10 to-emerald-600/5' : 'from-amber-500/10 to-amber-600/5'}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-xl ${isArr ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-amber-500/20 border-amber-500/30'} border flex items-center justify-center">
                                            <i class="fa-solid fa-history ${isArr ? 'text-emerald-400' : 'text-amber-400'}"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-display font-bold text-lg text-white">${flightNo}</h3>
                                            <p class="text-xs text-gray-400">Değişiklik Geçmişi</p>
                                        </div>
                                    </div>
                                    <button onclick="document.getElementById('historyModal').remove()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-gray-400 hover:text-white transition">
                                        <i class="fa-solid fa-times"></i>
                                    </button>
                                </div>
                                <div class="p-4 space-y-2 max-h-[60vh] overflow-y-auto custom-scroll">
                                    ${historyHtml}
                                </div>
                                <div class="p-3 border-t border-white/10 bg-white/5 text-center">
                                    <span class="text-[10px] text-gray-500">Son ${history.length} değişiklik gösteriliyor</span>
                                </div>
                            </div>
                        </div>`;

                        // Mevcut modalı kaldır ve yenisini ekle
                        const existingModal = document.getElementById('historyModal');
                        if (existingModal) existingModal.remove();
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                    },

                    smartReset: () => {
                        const currentStaff = app.state.staff;
                        app.state = {
                            flights: [],
                            shift: 'day',
                            customStart: 480, customEnd: 1200,
                            staff: currentStaff,
                            assignments: {},
                            gates: {},
                            overrides: {},
                            completed: [],
                            delayed: {},
                            showCompleted: true,
                            filterMode: 'all',
                            baseDate: null
                        };
                        app.data.save(); app.ui.render(); app.ui.renderStaff(); app.ui.updateHeaderShiftLabel();
                        app.ui.toast("Sistem Temizlendi", "success");
                        document.getElementById('confirmModal').classList.add('hidden');
                    },

                    render: () => {
                        const grid = document.getElementById('flightGrid'); if (!grid) return; grid.innerHTML = '';
                        const elSearch = document.getElementById('searchInput'); const term = elSearch ? elSearch.value.toLowerCase().replace(/\s+/g, '') : '';
                        const flights = app.state.flights;
                        const emptyState = document.getElementById('emptyState');
                        if (flights.length === 0) { if (emptyState) emptyState.classList.remove('hidden'); return; } else { if (emptyState) emptyState.classList.add('hidden'); }
                        const sorted = [...flights].sort((a, b) => a.timestamp - b.timestamp);
                        let counts = { total: flights.length, focus: 0, done: app.state.completed.length, assigned: 0 };

                        // Admin kontrolü - kullanıcı modunda inputlar disabled olacak
                        const isAdmin = app.isAdmin;
                        const disabledAttr = isAdmin ? '' : 'disabled';
                        const adminOnlyClass = isAdmin ? '' : 'pointer-events-none opacity-50';

                        sorted.forEach((f, idx) => {
                            const searchStr = (f.flightNo + f.airline + f.gate + f.route + f.type + f.rawAirline + f.flightNoOnly).toLowerCase().replace(/\s+/g, '');
                            let match = searchStr.includes(term);
                            if (!match && term.length > 0) { const aliases = f.rawAirline.split('/').map(x => x.trim().toLowerCase()); match = aliases.some(a => (a + f.flightNoOnly).includes(term)); }
                            if (term && !match) return;
                            const isDone = app.state.completed.includes(f.id);

                            let inFocus = false;
                            if (app.state.overrides[f.id] === 'focus') inFocus = true;
                            else if (app.state.overrides[f.id] !== 'hide') {
                                const date = new Date(f.timestamp);
                                const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0);

                                if (app.state.shift === 'all') { inFocus = true; }
                                else { if (m >= app.state.customStart && m <= app.state.customEnd) inFocus = true; }
                            }

                            if (app.state.filterMode === 'focus' && !inFocus) return; if (app.state.filterMode === 'completed' && !isDone) return; if (isDone && !app.state.showCompleted && app.state.filterMode !== 'completed') return;
                            // Güncellenmiş filtresi
                            if (app.state.showUpdatedOnly && !f.wasUpdated && !f.gateUpdated && !(app.state.timeChanges && app.state.timeChanges[f.id])) return;
                            if (inFocus && !isDone) counts.focus++; if (app.state.assignments[f.id]) counts.assigned++;
                            const originalGate = f.originalGate || ""; const savedGate = app.state.gates[f.id] !== undefined ? app.state.gates[f.id] : originalGate; const savedStaff = app.state.assignments[f.id] || ''; const isGateChanged = String(savedGate).trim() !== String(originalGate).trim();
                            const isTimeChanged = app.state.timeChanges && app.state.timeChanges[f.id] !== undefined;
                            const isArr = f.type === 'ARR'; const typeClass = isArr ? 'card-arr' : 'card-dep'; const icon = isArr ? 'fa-plane-arrival' : 'fa-plane-departure'; const label = isArr ? 'GELİŞ' : 'GİDİŞ'; const iconColor = isArr ? 'text-emerald-400' : 'text-amber-400';
                            // Format flight number: airline code left, flight number right (PC | 3094)
                            const flightLetters = (f.flightNo.replace(/[0-9]/g, '').trim() || f.airline.split('/')[0].trim()).toUpperCase();
                            const flightNumbers = f.flightNo.replace(/[^0-9]/g, '').trim() || f.flightNo;
                            const dateObj = new Date(f.timestamp); const dateLabel = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });

                            // Delay Logic
                            const isDelayed = app.state.delayed[f.id];
                            const delayClass = isDelayed ? 'is-delayed' : '';
                            const delayBadge = isDelayed ? `<div class="absolute top-0 right-0 bg-red-600 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg z-20 animate-pulse">GECİKME</div>` : '';

                            // Time Changed Class
                            const timeChangedClass = isTimeChanged ? 'time-changed' : '';

                            // Yeni/Güncellenen Badge'leri
                            let updateBadge = '';
                            const gateChangedClass = (f.gateUpdated || isGateChanged) ? 'gate-changed' : '';
                            if (isTimeChanged) {
                                updateBadge = `<div class="absolute top-0 left-0 bg-cyan-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-xl z-20 flex items-center gap-1.5 animate-pulse shadow-lg"><i class="fa-solid fa-clock"></i> SAAT GÜNCELLENDİ</div>`;
                            } else if (f.gateUpdated || (f.wasUpdated && isGateChanged)) {
                                updateBadge = `<div class="absolute top-0 left-0 bg-amber-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-xl z-20 flex items-center gap-1.5 animate-pulse shadow-lg"><i class="fa-solid fa-door-open"></i> KAPI GÜNCELLENDİ</div>`;
                            } else if (f.wasUpdated) {
                                updateBadge = `<div class="absolute top-0 left-0 bg-green-500 text-white text-[10px] font-bold px-3 py-1 rounded-br-xl z-20 flex items-center gap-1.5 animate-pulse shadow-lg"><i class="fa-solid fa-plus"></i> YENİ EKLENEN</div>`;
                            }

                            const el = document.createElement('div');
                            el.className = `flight-card rounded-2xl flex flex-col md:flex-row min-h-auto md:min-h-[110px] ${typeClass} ${inFocus && !isDone ? 'in-focus' : 'is-dimmed'} ${isDone ? 'is-completed' : ''} ${delayClass} ${timeChangedClass} ${gateChangedClass} mb-3 md:mb-4 relative overflow-hidden shadow-lg`;
                            const completedOverlay = isDone ? `<div class="absolute right-4 top-3 z-50 pointer-events-none transform -rotate-6 opacity-70"><div class="border-2 border-emerald-500/50 text-emerald-400 font-display font-bold text-xs px-3 py-1 rounded-lg uppercase tracking-widest backdrop-blur-sm bg-emerald-500/10">✓ TAMAMLANDI</div></div>` : '';
                            el.innerHTML = `${completedOverlay}${delayBadge}${updateBadge}
                            <div class="w-full md:w-36 bg-gradient-to-br from-black/30 to-black/10 flex flex-row md:flex-col items-center justify-between p-3 border-b md:border-b-0 md:border-r border-white/10">
                                <div class="flex items-center gap-3 md:hidden w-full">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br ${isArr ? 'from-emerald-500/30 to-emerald-600/20' : 'from-amber-500/30 to-amber-600/20'} flex items-center justify-center border-2 ${isArr ? 'border-emerald-500/50' : 'border-amber-500/50'}"><i class="fa-solid ${icon} ${iconColor} text-3xl"></i></div>
                                    <div class="flex-1 flex flex-col gap-1">
                                        <input type="time" value="${f.timeStr}" onchange="app.logic.updateFlightTime('${f.id}', this.value)" class="w-full text-xl font-mono font-bold text-white bg-black/30 border ${timeChangedClass ? 'border-blue-500 border-2' : 'border-white/10'} rounded-lg px-2 py-1.5 text-center focus:border-blue-500 outline-none ${timeChangedClass} ${adminOnlyClass}" ${disabledAttr}>
                                        <div class="text-sm font-extrabold ${isArr ? 'text-emerald-400 bg-emerald-500/20 border-emerald-500/30' : 'text-amber-400 bg-amber-500/20 border-amber-500/30'} px-2 py-1 rounded-lg uppercase text-center border">${isArr ? '✈ İNİŞ' : '✈ KALKIŞ'}</div>
                                    </div>
                                    ${(app.state.flightHistory && app.state.flightHistory[f.id] && app.state.flightHistory[f.id].length > 0) ? `<button onclick="app.ui.showFlightHistory('${f.id}')" class="w-8 h-8 rounded-full bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 flex items-center justify-center border border-blue-500/30" title="Değişiklik Geçmişi"><i class="fa-solid fa-history text-xs"></i></button>` : ''}
                                </div>
                                <div class="hidden md:flex md:flex-col md:items-center md:text-center w-full gap-1">
                                    <div class="w-14 h-14 rounded-xl bg-gradient-to-br ${isArr ? 'from-emerald-500/30 to-emerald-600/20' : 'from-amber-500/30 to-amber-600/20'} flex items-center justify-center border-2 ${isArr ? 'border-emerald-500/50' : 'border-amber-500/50'}"><i class="fa-solid ${icon} ${iconColor} text-2xl"></i></div>
                                    <input type="time" value="${f.timeStr}" onchange="app.logic.updateFlightTime('${f.id}', this.value)" class="w-full text-lg font-mono font-bold text-white bg-black/30 border ${timeChangedClass ? 'border-blue-500 border-2' : 'border-white/10'} rounded-lg px-1 py-1 text-center focus:border-blue-500 outline-none ${timeChangedClass} ${adminOnlyClass}" ${disabledAttr}>
                                    <span class="text-[8px] font-bold text-indigo-400 bg-indigo-500/10 px-1.5 py-0.5 rounded">${dateLabel}</span>
                                    <div class="text-xs font-extrabold ${isArr ? 'text-emerald-400 bg-emerald-500/20 border-emerald-500/30' : 'text-amber-400 bg-amber-500/20 border-amber-500/30'} px-2 py-0.5 rounded-md uppercase border">${isArr ? 'İNİŞ' : 'KALKIŞ'}</div>
                                </div>
                            </div>
                            <div class="flex-1 p-3 md:p-4 flex flex-col justify-center">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xl md:text-2xl font-display font-extrabold text-blue-400 tracking-wide">${flightLetters}</span>
                                    <span class="text-2xl md:text-3xl font-display font-bold text-white tracking-tight">${flightNumbers}</span>
                                    ${(app.state.flightHistory && app.state.flightHistory[f.id] && app.state.flightHistory[f.id].length > 0) ? `<button onclick="event.stopPropagation(); app.ui.showFlightHistory('${f.id}')" class="w-6 h-6 rounded-full bg-blue-500/30 hover:bg-blue-500/50 text-blue-400 flex items-center justify-center border border-blue-500/40" title="Değişiklik Geçmişi (${app.state.flightHistory[f.id].length})"><i class="fa-solid fa-history text-[9px]"></i></button>` : ''}
                                </div>
                                <div class="flex items-center gap-2 text-sm">
                                    <i class="fa-solid fa-route text-[10px] text-blue-400"></i>
                                    <span class="text-gray-300 font-medium">${f.route}</span>
                                </div>
                            </div>
                            <div class="w-full md:w-56 p-3 md:p-4 flex flex-col justify-center gap-2 bg-gradient-to-br from-black/20 to-transparent border-t md:border-t-0 md:border-l border-white/10">
                                <div class="flex gap-2">
                                    <div class="gate-input-wrapper rounded-lg p-1 bg-black/30 border ${isGateChanged ? 'border-amber-500 gate-changed' : 'border-white/10'}">
                                        <label class="block text-[7px] text-gray-500 font-bold uppercase text-center tracking-wider">KAPI</label>
                                        <input type="text" value="${savedGate}" onchange="app.logic.updateGate('${f.id}', this.value)" class="ghost text-center font-mono font-extrabold text-3xl text-white tracking-widest h-9 w-16 ${adminOnlyClass}" placeholder="---" ${disabledAttr}>
                                    </div>
                                    <div class="flex flex-col gap-1">
                                        <button onclick="app.logic.toggleOverride('${f.id}', '${inFocus ? 'hide' : 'focus'}')" class="w-9 h-8 rounded-lg bg-white/10 hover:bg-white/20 text-gray-400 hover:text-white transition flex items-center justify-center ${adminOnlyClass}" title="${inFocus ? 'Gizle' : 'Odakla'}" ${disabledAttr}><i class="fa-solid ${inFocus ? 'fa-eye-slash' : 'fa-thumbtack'} text-[10px]"></i></button>
                                        <button onclick="app.logic.toggleDelay('${f.id}')" class="w-9 h-8 rounded-lg ${isDelayed ? 'bg-red-500 text-white' : 'bg-white/5 text-gray-500 hover:text-red-400'} transition flex items-center justify-center ${adminOnlyClass}" title="Gecikme" ${disabledAttr}><i class="fa-solid fa-clock text-[10px]"></i></button>
                                        <button onclick="app.logic.toggleComplete('${f.id}')" class="w-9 h-8 rounded-lg ${isDone ? 'bg-slate-600 text-white' : 'bg-emerald-500/20 hover:bg-emerald-600 text-emerald-400 hover:text-white'} transition flex items-center justify-center ${adminOnlyClass}" title="${isDone ? 'Geri Al' : 'Tamamla'}" ${disabledAttr}><i class="fa-solid ${isDone ? 'fa-rotate-left' : 'fa-check'} text-[10px]"></i></button>
                                    </div>
                                </div>
                                <div class="relative">
                                    <i class="fa-solid fa-user text-[10px] text-gray-500 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input list="staffOptions" value="${savedStaff}" onchange="app.logic.assignStaff('${f.id}', this.value)" placeholder="Personel..." class="w-full bg-black/20 hover:bg-black/30 focus:bg-blue-500/10 border border-white/10 focus:border-blue-500/50 rounded-lg text-xs font-bold text-white py-2 pl-8 pr-2 outline-none transition uppercase placeholder-gray-600 ${adminOnlyClass}" ${disabledAttr}>
                                </div>
                            </div>
                        `;
                            grid.appendChild(el);
                        });
                        document.getElementById('statTotal').innerText = sorted.length; document.getElementById('statFocus').innerText = counts.focus; document.getElementById('statDone').innerText = counts.done; document.getElementById('statAssigned').innerText = counts.assigned;
                    },
                    renderStaff: () => {
                        const counts = {}; app.state.staff.forEach(s => counts[s] = 0); app.state.completed.forEach(fid => { const s = app.state.assignments[fid]; if (s && counts.hasOwnProperty(s)) counts[s]++; });
                        document.getElementById('staffOptions').innerHTML = app.state.staff.map(s => `<option value="${s}">`).join('');
                        document.getElementById('staffList').innerHTML = app.state.staff.map(s => `
                        <div class="flex justify-between items-center bg-white/5 p-2 rounded-lg border border-white/5 group hover:border-white/20 transition hover:bg-white/10 hover:translate-x-1 duration-200"><span class="text-xs font-bold text-gray-300 uppercase tracking-wide flex items-center gap-3"><span class="w-6 h-6 rounded bg-blue-500/10 flex items-center justify-center text-blue-400"><i class="fa-solid fa-user-astronaut text-[10px]"></i></span>${s}</span><div class="flex items-center gap-2"><span class="text-[10px] font-bold text-emerald-400 bg-emerald-500/10 px-2 py-0.5 rounded border border-emerald-500/20">${counts[s] || 0}</span><button onclick="app.logic.removeStaff('${s}')" class="text-gray-500 hover:text-red-400 p-1.5"><i class="fa-solid fa-trash text-xs"></i></button></div></div>
                    `).join('');
                    }
                },
                logic: {
                    pendingExcelData: null, // Bekleyen Excel verisi
                    handleFileUpload: (e) => {
                        if (!app.isAdmin) { app.ui.toast('Bu işlem için admin yetkisi gerekli', 'error'); e.target.value = ''; return; }
                        const file = e.target.files[0]; if (!file) return;
                        const r = new FileReader();
                        r.onload = (evt) => {
                            const wb = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                            // Mevcut veri var mı kontrol et
                            if (app.state.flights.length > 0) {
                                app.logic.pendingExcelData = json;
                                app.ui.showExcelMergeModal();
                            } else {
                                app.logic.parse(json);
                            }
                        };
                        r.readAsArrayBuffer(file); e.target.value = '';
                    },
                    mergeExcelData: () => {
                        if (!app.logic.pendingExcelData) return;
                        const rows = app.logic.pendingExcelData;
                        let hIdx = -1, dateStr = "";
                        for (let i = 0; i < Math.min(rows.length, 25); i++) { if (!rows[i]) continue; const s = rows[i].join(" ").toUpperCase(); if (s.match(/(\d{2}\.\d{2}\.\d{4})/)) dateStr = s.match(/(\d{2}\.\d{2}\.\d{4})/)[1]; if (s.includes("FLIGHT NO") && s.includes("AIRLINE")) { hIdx = i; break; } }
                        if (hIdx === -1) { app.ui.toast("Header Bulunamadı!", "error"); app.logic.pendingExcelData = null; return; }
                        const header = rows[hIdx].map(x => String(x).toUpperCase().trim());
                        const m = { airline: -1, gate: -1, route: -1, arrNo: -1, arrTime: -1, depNo: -1, depTime: -1 };
                        header.forEach((c, i) => { if (c.includes("AIRLINE")) m.airline = i; if (c.includes("BRIDGE") || c.includes("GATE")) m.gate = i; if (c.includes("STATIONS") || c.includes("ROUTE")) m.route = i; });
                        const split = Math.floor(header.length / 2);
                        header.forEach((c, i) => { if (i < split) { if (c.includes("FLIGHT") || c.includes("NO")) m.arrNo = i; if (c.includes("STA") || c.includes("TIME")) m.arrTime = i; } else { if ((c.includes("FLIGHT") || c.includes("NO")) && m.depNo === -1) m.depNo = i; if ((c.includes("STD") || c.includes("TIME")) && m.depTime === -1) m.depTime = i; } });
                        const toMins = (v) => { if (typeof v === 'number') return Math.round(v * 1440); if (typeof v === 'string' && v.includes(':')) { const [h, mn] = v.split(':').map(Number); return h * 60 + mn; } return null; };
                        const data = rows.slice(hIdx + 1);
                        let stats = { updated: 0, added: 0, unchanged: 0 };
                        data.forEach((row, idx) => {
                            if (!row || !row[m.arrNo] && !row[m.depNo]) return;
                            const air = row[m.airline] || ""; const gate = row[m.gate] || "";
                            // ARR uçuşunu kontrol et
                            if (row[m.arrNo] && row[m.arrTime]) {
                                const tm = toMins(row[m.arrTime]); if (tm === null) return;
                                const h = Math.floor(tm / 60), mn = tm % 60;
                                const timeStr = `${String(h).padStart(2, '0')}:${String(mn).padStart(2, '0')}`;
                                const flightNo = String(row[m.arrNo]).trim();
                                const isNextDay = tm < 900; // 15:00'dan önce ertesi gün (parse ile tutarlı)
                                const existing = app.state.flights.find(f => f.flightNo === flightNo && f.type === 'ARR' && f.isNextDay === isNextDay);
                                if (existing) {
                                    const newGate = String(gate).trim();
                                    if (existing.originalGate !== newGate) {
                                        existing.originalGate = newGate;
                                        app.state.gates[existing.id] = newGate;
                                        existing.wasUpdated = true;
                                        existing.gateUpdated = true;
                                        stats.updated++;

                                        // Bağlı uçuşu da güncelle (pairId ile)
                                        if (existing.pairId) {
                                            const paired = app.state.flights.find(f => f.pairId === existing.pairId && f.id !== existing.id);
                                            if (paired) {
                                                paired.originalGate = newGate;
                                                app.state.gates[paired.id] = newGate;
                                                paired.wasUpdated = true;
                                                paired.gateUpdated = true;
                                            }
                                        }
                                    } else { stats.unchanged++; }
                                } else {
                                    // Yeni uçuş ekle
                                    const pairId = `pair-${idx}-${Math.random().toString(36).substr(2, 4)}`;
                                    const baseDate = app.state.baseDate ? new Date(app.state.baseDate) : new Date();
                                    const routeRaw = row[m.route] || ""; let from = routeRaw; if (routeRaw.includes("-")) from = routeRaw.split("-")[0].trim();
                                    const isNextDay = tm < 900; const d = new Date(baseDate); if (isNextDay) d.setDate(d.getDate() + 1); d.setHours(h, mn, 0, 0);
                                    app.state.flights.push({ id: `ARR-${idx}-${Math.random().toString(36).substr(2, 5)}`, type: 'ARR', flightNo: flightNo, flightNoOnly: flightNo.match(/\d+/)?.[0] || flightNo, rawAirline: String(air).trim(), airline: String(air).split('/')[0].trim(), gate: String(gate).trim(), originalGate: String(gate).trim(), route: from, timestamp: d.getTime(), timeStr: timeStr, isNextDay: isNextDay, pairId: pairId, wasUpdated: true });
                                    stats.added++;
                                }
                            }
                            // DEP uçuşunu kontrol et
                            if (row[m.depNo] && row[m.depTime]) {
                                const tm = toMins(row[m.depTime]); if (tm === null) return;
                                const h = Math.floor(tm / 60), mn = tm % 60;
                                const timeStr = `${String(h).padStart(2, '0')}:${String(mn).padStart(2, '0')}`;
                                const flightNo = String(row[m.depNo]).trim();
                                const isNextDay = tm < 900; // 15:00'dan önce ertesi gün (parse ile tutarlı)
                                const existing = app.state.flights.find(f => f.flightNo === flightNo && f.type === 'DEP' && f.isNextDay === isNextDay);
                                if (existing) {
                                    const newGate = String(gate).trim();
                                    if (existing.originalGate !== newGate) {
                                        existing.originalGate = newGate;
                                        app.state.gates[existing.id] = newGate;
                                        existing.wasUpdated = true;
                                        existing.gateUpdated = true;
                                        stats.updated++;

                                        // Bağlı uçuşu da güncelle (pairId ile)
                                        if (existing.pairId) {
                                            const paired = app.state.flights.find(f => f.pairId === existing.pairId && f.id !== existing.id);
                                            if (paired) {
                                                paired.originalGate = newGate;
                                                app.state.gates[paired.id] = newGate;
                                                paired.wasUpdated = true;
                                                paired.gateUpdated = true;
                                            }
                                        }
                                    } else { stats.unchanged++; }
                                } else {
                                    // Yeni uçuş ekle
                                    const pairId = `pair-${idx}-${Math.random().toString(36).substr(2, 4)}`;
                                    const baseDate = app.state.baseDate ? new Date(app.state.baseDate) : new Date();
                                    const routeRaw = row[m.route] || ""; let to = routeRaw; if (routeRaw.includes("-")) to = routeRaw.split("-")[1]?.trim() || routeRaw;
                                    const isNextDay = tm < 900; const d = new Date(baseDate); if (isNextDay) d.setDate(d.getDate() + 1); d.setHours(h, mn, 0, 0);
                                    app.state.flights.push({ id: `DEP-${idx}-${Math.random().toString(36).substr(2, 5)}`, type: 'DEP', flightNo: flightNo, flightNoOnly: flightNo.match(/\d+/)?.[0] || flightNo, rawAirline: String(air).trim(), airline: String(air).split('/')[0].trim(), gate: String(gate).trim(), originalGate: String(gate).trim(), route: to, timestamp: d.getTime(), timeStr: timeStr, isNextDay: isNextDay, pairId: pairId, wasUpdated: true });
                                    stats.added++;
                                }
                            }
                        });
                        app.state.flights.sort((a, b) => a.timestamp - b.timestamp);
                        app.logic.pendingExcelData = null;
                        document.getElementById('excelMergeModal')?.classList.add('hidden');
                        app.data.save(); app.ui.render();
                        app.ui.toast(`Güncelleme: ${stats.updated} değişti, ${stats.added} yeni, ${stats.unchanged} aynı`, 'success');
                    },
                    replaceWithNewExcel: () => {
                        if (!app.logic.pendingExcelData) return;
                        document.getElementById('excelMergeModal')?.classList.add('hidden');
                        app.logic.parse(app.logic.pendingExcelData);
                        app.logic.pendingExcelData = null;
                    },
                    parse: (rows) => {
                        let hIdx = -1, dateStr = "";
                        for (let i = 0; i < Math.min(rows.length, 25); i++) { if (!rows[i]) continue; const s = rows[i].join(" ").toUpperCase(); if (s.match(/(\d{2}\.\d{2}\.\d{4})/)) dateStr = s.match(/(\d{2}\.\d{2}\.\d{4})/)[1]; if (s.includes("FLIGHT NO") && s.includes("AIRLINE")) { hIdx = i; break; } }
                        if (hIdx === -1) { app.ui.toast("Header Bulunamadı!", "error"); return; }
                        const header = rows[hIdx].map(x => String(x).toUpperCase().trim());
                        const m = { airline: -1, gate: -1, route: -1, arrNo: -1, arrTime: -1, depNo: -1, depTime: -1 };
                        header.forEach((c, i) => { if (c.includes("AIRLINE")) m.airline = i; if (c.includes("BRIDGE") || c.includes("GATE")) m.gate = i; if (c.includes("STATIONS") || c.includes("ROUTE")) m.route = i; });
                        const split = Math.floor(header.length / 2);
                        header.forEach((c, i) => { if (i < split) { if (c.includes("FLIGHT") || c.includes("NO")) m.arrNo = i; if (c.includes("STA") || c.includes("TIME")) m.arrTime = i; } else { if ((c.includes("FLIGHT") || c.includes("NO")) && m.depNo === -1) m.depNo = i; if ((c.includes("STD") || c.includes("TIME")) && m.depTime === -1) m.depTime = i; } });
                        const toMins = (v) => { if (typeof v === 'number') return Math.round(v * 1440); if (typeof v === 'string' && v.includes(':')) { const [h, m] = v.split(':').map(Number); return h * 60 + m; } return null; };
                        const data = rows.slice(hIdx + 1); app.state.flights = []; let baseDate = new Date(); if (dateStr) { const p = dateStr.split('.'); baseDate = new Date(p[2], p[1] - 1, p[0]); } app.state.baseDate = baseDate.toISOString();
                        data.forEach((row, idx) => {
                            const air = row[m.airline] || ""; const gate = row[m.gate] || ""; const routeRaw = row[m.route] || ""; let from = routeRaw, to = routeRaw; if (routeRaw.includes("-")) { const p = routeRaw.split("-"); from = p[0].trim(); to = p[1].trim(); }
                            const pairId = `pair-${idx}-${Math.random().toString(36).substr(2, 4)}`;
                            const createFlight = (t, type, no, route, pair) => { const isNextDay = t < 900; const d = new Date(baseDate); if (isNextDay) d.setDate(d.getDate() + 1); const h = Math.floor(t / 60), mn = t % 60; d.setHours(h, mn, 0, 0); const fClean = String(no).trim(); const numMatch = fClean.match(/\d+/); const fNum = numMatch ? numMatch[0] : fClean; return { id: `${type}-${idx}-${Math.random().toString(36).substr(2, 5)}`, type: type, flightNo: fClean, flightNoOnly: fNum, rawAirline: String(air).trim(), airline: String(air).split('/')[0].trim(), gate: String(gate).trim(), originalGate: String(gate).trim(), route: route, timestamp: d.getTime(), timeStr: `${String(h).padStart(2, '0')}:${String(mn).padStart(2, '0')}`, isNextDay: isNextDay, pairId: pair }; };
                            if (row[m.arrNo] && row[m.arrTime]) { const tm = toMins(row[m.arrTime]); if (tm !== null) app.state.flights.push(createFlight(tm, 'ARR', row[m.arrNo], from, pairId)); }
                            if (row[m.depNo] && row[m.depTime]) { const tm = toMins(row[m.depTime]); if (tm !== null) app.state.flights.push(createFlight(tm, 'DEP', row[m.depNo], to, pairId)); }
                        });
                        app.state.flights.sort((a, b) => a.timestamp - b.timestamp); app.data.save();
                        // TRIGGER WIZARD
                        app.ui.showShiftConfig();
                        app.ui.toast("Dosya Okundu. Vardiya Seçin.", "success");
                    },
                    applyShiftConfig: () => {
                        let type = 'all'; if (document.getElementById('sc-btn-day').classList.contains('active')) type = 'day'; else if (document.getElementById('sc-btn-night').classList.contains('active')) type = 'night';
                        const startVal = document.getElementById('sc-start').value; const endVal = document.getElementById('sc-end').value;
                        const timeToMins = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
                        let startMins = timeToMins(startVal); let endMins = timeToMins(endVal);
                        if (endMins < startMins) { endMins += 1440; }
                        app.state.shift = type; app.state.customStart = startMins; app.state.customEnd = endMins;
                        document.getElementById('shiftConfigModal').classList.add('hidden'); app.ui.updateHeaderShiftLabel(); app.ui.render(); app.data.save(); app.ui.toast("Vardiya Başlatıldı", "success");
                    },
                    setShift: (s) => { app.ui.showShiftConfig(); }, // Re-opens wizard
                    // History için yardımcı fonksiyonlar
                    pushHistory: () => {
                        const snapshot = JSON.stringify({
                            flights: JSON.parse(JSON.stringify(app.state.flights)), // Deep copy
                            assignments: app.state.assignments,
                            gates: app.state.gates,
                            overrides: app.state.overrides,
                            completed: app.state.completed,
                            delayed: app.state.delayed,
                            timeChanges: app.state.timeChanges
                        });
                        if (!app.state.history) app.state.history = [];
                        app.state.history.push(snapshot);
                        if (app.state.history.length > 10) app.state.history.shift();
                    },
                    undo: () => {
                        if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; }
                        if (!app.state.history || app.state.history.length === 0) { app.ui.toast("Geri alınacak işlem yok", "info"); return; }
                        const prev = JSON.parse(app.state.history.pop());
                        if (prev.flights) app.state.flights = prev.flights;
                        app.state.assignments = prev.assignments || {};
                        app.state.gates = prev.gates || {};
                        app.state.overrides = prev.overrides || {};
                        app.state.completed = prev.completed || [];
                        app.state.delayed = prev.delayed || {};
                        app.state.timeChanges = prev.timeChanges || {};
                        app.data.save(); app.ui.render(); app.ui.renderStaff();
                        app.ui.toast("Son işlem geri alındı", "success");
                    },
                    clearUpdateBadges: () => {
                        app.state.flights.forEach(f => { delete f.wasUpdated; delete f.gateUpdated; });
                        app.state.timeChanges = {};
                        app.data.save(); app.ui.render();
                        app.ui.toast("Güncelleme işaretleri temizlendi", "success");
                    },
                    toggleUpdatedFilter: () => {
                        app.state.showUpdatedOnly = !app.state.showUpdatedOnly;
                        const btn = document.getElementById('btnUpdatedFilter');
                        if (btn) btn.classList.toggle('bg-amber-500/20', app.state.showUpdatedOnly);
                        app.ui.render();
                        app.ui.toast(app.state.showUpdatedOnly ? "Sadece güncellenmiş" : "Tümü görünüyor", "info");
                    },
                    // Uçuş değişiklik geçmişi
                    logHistory: (id, field, oldValue, newValue) => {
                        if (!app.state.flightHistory) app.state.flightHistory = {};
                        if (!app.state.flightHistory[id]) app.state.flightHistory[id] = [];
                        app.state.flightHistory[id].push({ timestamp: Date.now(), field, oldValue, newValue });
                        if (app.state.flightHistory[id].length > 10) app.state.flightHistory[id].shift();
                    },
                    toggleOverride: (id, act) => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } app.logic.pushHistory(); if (app.state.overrides[id] === act) delete app.state.overrides[id]; else app.state.overrides[id] = act; app.data.save(); app.ui.render(); },
                    toggleComplete: (id) => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } app.logic.pushHistory(); if (app.state.completed.includes(id)) app.state.completed = app.state.completed.filter(x => x !== id); else app.state.completed.push(id); app.data.save(); app.ui.render(); app.ui.renderStaff(); },
                    toggleDelay: (id) => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } app.logic.pushHistory(); if (app.state.delayed[id]) delete app.state.delayed[id]; else app.state.delayed[id] = true; app.data.save(); app.ui.render(); },
                    assignStaff: (id, val) => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } app.logic.pushHistory(); app.state.assignments[id] = val; app.data.save(); app.ui.render(); app.ui.renderStaff(); },
                    updateGate: (id, val) => {
                        if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; }
                        app.logic.pushHistory();
                        const flight = app.state.flights.find(f => f.id === id);
                        const oldGate = app.state.gates[id] || (flight ? flight.originalGate : '');
                        app.state.gates[id] = val;
                        // Geçmişe kaydet
                        app.logic.logHistory(id, 'Kapı', oldGate, val);
                        // Bağlı uçuşu da güncelle (aynı pairId'ye sahip)
                        if (flight && flight.pairId) {
                            const paired = app.state.flights.find(f => f.pairId === flight.pairId && f.id !== id);
                            if (paired) {
                                const oldPairedGate = app.state.gates[paired.id] || paired.originalGate;
                                app.state.gates[paired.id] = val;
                                app.logic.logHistory(paired.id, 'Kapı', oldPairedGate, val);
                                app.ui.toast(`Bağlı ${paired.type === 'ARR' ? 'iniş' : 'kalkış'} da güncellendi`, 'info');
                            }
                        }
                        app.data.save(); app.ui.render();
                    },
                    updateFlightTime: (id, newTime) => {
                        if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; }
                        console.log('updateFlightTime called:', id, newTime);
                        if (!newTime) { console.log('No new time provided'); return; }
                        const flight = app.state.flights.find(f => f.id === id);
                        if (!flight) { console.log('Flight not found:', id); return; }

                        // Aynı saat ise işlem yapma
                        if (flight.timeStr === newTime) { console.log('Same time, skipping'); return; }

                        app.logic.pushHistory();
                        const originalTime = flight.originalTimeStr || flight.timeStr;
                        flight.originalTimeStr = flight.originalTimeStr || flight.timeStr;
                        flight.timeStr = newTime;

                        const [h, m] = newTime.split(':').map(Number);
                        const baseDate = app.state.baseDate ? new Date(app.state.baseDate) : new Date();
                        const d = new Date(baseDate);
                        const mins = h * 60 + m;
                        flight.isNextDay = mins < 360;
                        if (flight.isNextDay) d.setDate(d.getDate() + 1);
                        d.setHours(h, m, 0, 0);
                        flight.timestamp = d.getTime();

                        // timeChanges'e kaydet (badge için)
                        if (newTime !== originalTime) {
                            if (!app.state.timeChanges) app.state.timeChanges = {};
                            app.state.timeChanges[id] = { original: originalTime, new: newTime };
                            app.logic.logHistory(id, 'Saat', originalTime, newTime);
                            console.log('Time changed:', originalTime, '->', newTime);
                        } else {
                            delete app.state.timeChanges[id];
                        }

                        // Yeniden sırala
                        app.state.flights.sort((a, b) => a.timestamp - b.timestamp);

                        app.data.save();
                        app.ui.render();
                        app.ui.toast(`Saat güncellendi: ${originalTime} → ${newTime}`, 'success');
                    },
                    addManualFlight: () => {
                        if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; }
                        const type = document.getElementById('af-type-arr').className.includes('bg-emerald-500') ? 'ARR' : 'DEP';
                        const time = document.getElementById('af-time').value;
                        const flightNo = document.getElementById('af-flightno').value.trim().toUpperCase();
                        const airline = document.getElementById('af-airline').value.trim().toUpperCase();
                        const route = document.getElementById('af-route').value.trim().toUpperCase();
                        const gate = document.getElementById('af-gate').value.trim();
                        if (!time) { app.ui.toast('Saat seçiniz!', 'error'); return; }
                        if (!flightNo) { app.ui.toast('Uçuş numarası giriniz!', 'error'); return; }
                        if (!airline) { app.ui.toast('Havayolu giriniz!', 'error'); return; }
                        if (!route) { app.ui.toast('Rota giriniz!', 'error'); return; }
                        const [h, m] = time.split(':').map(Number);
                        const mins = h * 60 + m;
                        const baseDate = app.state.baseDate ? new Date(app.state.baseDate) : new Date();
                        const isNextDay = mins < 360;
                        const d = new Date(baseDate);
                        if (isNextDay) d.setDate(d.getDate() + 1);
                        d.setHours(h, m, 0, 0);
                        const numMatch = flightNo.match(/\d+/);
                        const fNum = numMatch ? numMatch[0] : flightNo;
                        const newFlight = {
                            id: `MANUAL-${type}-${Date.now()}-${Math.random().toString(36).substr(2, 5)}`,
                            type: type, flightNo: flightNo, flightNoOnly: fNum, rawAirline: airline, airline: airline,
                            gate: gate, originalGate: gate, route: route, timestamp: d.getTime(),
                            timeStr: `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`, isNextDay: isNextDay, isManual: true
                        };
                        app.state.flights.push(newFlight);
                        app.state.flights.sort((a, b) => a.timestamp - b.timestamp);
                        app.data.save(); app.ui.render(); app.ui.toggleAddFlightModal();
                        app.ui.toast(`${flightNo} eklendi!`, 'success');
                    },

                    addStaff: () => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } const v = document.getElementById('newStaffName').value.trim().toUpperCase(); if (v && !app.state.staff.includes(v)) { app.state.staff.push(v); document.getElementById('newStaffName').value = ''; app.ui.renderStaff(); app.data.save(); app.ui.toast("Eklendi", "success"); } },
                    removeStaff: (s) => { if (!app.isAdmin) { app.ui.toast('Admin yetkisi gerekli', 'error'); return; } app.state.staff = app.state.staff.filter(x => x !== s); app.ui.renderStaff(); app.data.save(); },
                    analyze: () => {
                        const allFlights = app.state.flights; if (!allFlights.length) return;
                        const sortedF = [...allFlights].sort((a, b) => a.timestamp - b.timestamp);

                        // Odaklanılan uçuşları filtrele (vardiya seçimine göre)
                        const focusFlights = sortedF.filter(flight => {
                            const m = new Date(flight.timestamp).getHours() * 60 + new Date(flight.timestamp).getMinutes() + (flight.isNextDay ? 1440 : 0);
                            if (app.state.shift === 'all') return true;
                            return m >= app.state.customStart && m <= app.state.customEnd;
                        });

                        // Saatlik yoğunluk
                        let hourCounts = {};
                        focusFlights.forEach(f => {
                            const h = String(new Date(f.timestamp).getHours()).padStart(2, '0');
                            hourCounts[h] = (hourCounts[h] || 0) + 1;
                        });
                        const orderedHours = [...new Set(focusFlights.map(f => String(new Date(f.timestamp).getHours()).padStart(2, '0')))];
                        const maxVal = Math.max(...Object.values(hourCounts), 1);
                        const chartHtml = orderedHours.map(h => {
                            const count = hourCounts[h] || 0;
                            const pct = (count / maxVal) * 100;
                            const color = count > 5 ? 'bg-red-500' : (count > 2 ? 'bg-amber-500' : 'bg-emerald-500');
                            return `<div class="flex flex-col items-center gap-1 min-w-[30px]"><div class="w-full bg-white/5 rounded-t relative h-20 flex items-end"><div class="w-full ${color} opacity-80 rounded-t" style="height: ${pct}%"></div></div><div class="text-[9px] font-mono text-gray-400">${h}</div><div class="text-[8px] font-bold text-white">${count}</div></div>`;
                        }).join('');

                        // Personel yükü
                        let staffLoad = {};
                        app.state.staff.forEach(s => staffLoad[s] = { total: 0, done: 0 });
                        focusFlights.forEach(f => {
                            const s = app.state.assignments[f.id];
                            if (s && staffLoad[s]) {
                                staffLoad[s].total++;
                                if (app.state.completed.includes(f.id)) staffLoad[s].done++;
                            }
                        });
                        const staffHtml = Object.entries(staffLoad).filter(([_, v]) => v.total > 0).map(([name, data]) => {
                            const pct = data.total > 0 ? Math.round((data.done / data.total) * 100) : 0;
                            const color = pct === 100 ? 'bg-emerald-500' : (pct > 50 ? 'bg-blue-500' : 'bg-amber-500');
                            return `<div class="flex items-center gap-3 bg-black/20 p-2 rounded-lg"><div class="w-8 h-8 rounded-full ${color}/20 flex items-center justify-center"><i class="fa-solid fa-user text-xs ${color.replace('bg-', 'text-')}"></i></div><div class="flex-1"><div class="text-xs font-bold text-white">${name}</div><div class="w-full bg-white/10 rounded-full h-1.5 mt-1"><div class="${color} h-1.5 rounded-full" style="width: ${pct}%"></div></div></div><div class="text-right"><div class="text-lg font-bold text-white">${data.done}/${data.total}</div><div class="text-[9px] text-gray-500">${pct}%</div></div></div>`;
                        }).join('') || '<div class="text-gray-500 text-xs italic">Henüz atama yapılmamış</div>';

                        // Değişiklik özeti
                        const timeChangedCount = Object.keys(app.state.timeChanges || {}).length;
                        const gateChangedCount = focusFlights.filter(f => f.gateUpdated || (app.state.gates[f.id] && app.state.gates[f.id] !== f.originalGate)).length;
                        const newAddedCount = focusFlights.filter(f => f.wasUpdated && !f.gateUpdated).length;

                        // Tamamlanma oranı (ODAKLANILAN)
                        const completedInFocus = focusFlights.filter(f => app.state.completed.includes(f.id)).length;
                        const completionPct = focusFlights.length > 0 ? Math.round((completedInFocus / focusFlights.length) * 100) : 0;

                        // Gecikme analizi
                        const delayedCount = focusFlights.filter(f => app.state.delayed[f.id]).length;
                        const delayedFlights = focusFlights.filter(f => app.state.delayed[f.id]).slice(0, 5);
                        const delayHtml = delayedFlights.length ? delayedFlights.map(f => `<div class="flex items-center gap-2 bg-red-500/10 p-2 rounded border-l-2 border-red-500"><span class="font-mono text-white text-sm">${f.timeStr}</span><span class="font-bold text-red-400">${f.flightNo}</span></div>`).join('') : '<div class="text-gray-500 text-xs italic">Gecikme yok 🎉</div>';

                        // Mola aralıkları (30 dk+)
                        let gaps = [];
                        for (let i = 0; i < focusFlights.length - 1; i++) {
                            const diff = (focusFlights[i + 1].timestamp - focusFlights[i].timestamp) / 60000;
                            if (diff >= 30) {
                                gaps.push({ start: focusFlights[i].timeStr, end: focusFlights[i + 1].timeStr, min: Math.floor(diff) });
                            }
                        }
                        const gapsHtml = gaps.length ? gaps.map(g => `<div class="flex justify-between items-center bg-green-500/10 p-2 rounded border-l-2 border-green-500"><span class="font-mono text-white text-sm">${g.start} → ${g.end}</span><span class="font-bold text-green-400">${g.min} dk</span></div>`).join('') : '<div class="text-gray-500 text-xs italic">30 dk+ boşluk yok</div>';

                        // Personel bekleyen uçuş sayısı
                        const staffPendingHtml = app.state.staff.map(s => {
                            const pending = focusFlights.filter(f => app.state.assignments[f.id] === s && !app.state.completed.includes(f.id)).length;
                            if (pending === 0) return '';
                            return `<div class="flex items-center gap-2 bg-purple-500/10 p-2 rounded"><span class="text-purple-400 font-bold text-sm">${s}</span><span class="text-white font-bold">${pending} uçuş bekliyor</span></div>`;
                        }).filter(x => x).join('') || '<div class="text-gray-500 text-xs italic">Tüm atamalar tamamlandı 🎉</div>';


                        // Sonraki 1 saat uyarısı
                        const now = Date.now();
                        const nextHourFlights = focusFlights.filter(f => f.timestamp > now && f.timestamp <= now + 3600000 && !app.state.completed.includes(f.id));
                        const urgentAlert = nextHourFlights.length > 0 ? `<div class="bg-gradient-to-r from-amber-500/20 to-red-500/20 border border-amber-500/30 rounded-xl p-4 flex items-center gap-4"><div class="w-12 h-12 rounded-full bg-amber-500/20 flex items-center justify-center animate-pulse"><i class="fa-solid fa-bell text-amber-400 text-xl"></i></div><div><div class="text-amber-400 font-bold text-sm">⚡ YAKLAŞAN UÇUŞLAR</div><div class="text-white text-2xl font-bold">${nextHourFlights.length} uçuş</div><div class="text-gray-400 text-xs">Sonraki 1 saat içinde hazırlan!</div></div></div>` : '';

                        // Progress ring
                        const progressRing = `<svg class="w-24 h-24" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="3"/><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="${completionPct === 100 ? '#10b981' : '#3b82f6'}" stroke-width="3" stroke-dasharray="${completionPct}, 100" stroke-linecap="round"/><text x="18" y="20.35" class="fill-white text-[8px] font-bold" text-anchor="middle">${completionPct}%</text></svg>`;

                        document.getElementById('analysisContent').innerHTML = `
                        <div class="space-y-6">
                            ${urgentAlert}
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="glass p-4 rounded-xl border-l-4 border-blue-500"><div class="text-[10px] text-blue-400 uppercase font-bold">Odak Uçuş</div><div class="text-3xl font-bold text-white">${focusFlights.length}</div><div class="text-[9px] text-gray-500">/ ${allFlights.length} toplam</div></div>
                                <div class="glass p-4 rounded-xl border-l-4 border-emerald-500"><div class="text-[10px] text-emerald-400 uppercase font-bold">Tamamlanan</div><div class="text-3xl font-bold text-white">${completedInFocus}</div><div class="text-[9px] text-emerald-400">${completionPct}% başarı</div></div>
                                <div class="glass p-4 rounded-xl border-l-4 border-red-500"><div class="text-[10px] text-red-400 uppercase font-bold">Gecikmeli</div><div class="text-3xl font-bold text-white">${delayedCount}</div><div class="text-[9px] text-gray-500">dikkat!</div></div>
                                <div class="glass p-4 rounded-xl border-l-4 border-amber-500"><div class="text-[10px] text-amber-400 uppercase font-bold">Değişiklik</div><div class="text-3xl font-bold text-white">${timeChangedCount + gateChangedCount}</div><div class="text-[9px] text-gray-500">⏰${timeChangedCount} 🚪${gateChangedCount}</div></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-bar text-blue-400"></i> Saatlik Yoğunluk</h4><div class="flex items-end gap-1 overflow-x-auto pb-2">${chartHtml}</div></div>
                                <div class="glass p-4 rounded-xl flex flex-col items-center justify-center"><h4 class="text-xs text-gray-400 uppercase font-bold mb-2">Tamamlanma</h4>${progressRing}<div class="text-xs text-gray-500 mt-2">${completedInFocus} / ${focusFlights.length} uçuş</div></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-users text-purple-400"></i> Personel Yükü</h4><div class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-2">${staffHtml}</div></div>
                                <div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-clock text-red-400"></i> Gecikmeler</h4><div class="space-y-2 max-h-48 overflow-y-auto custom-scroll pr-2">${delayHtml}</div></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-coffee text-green-400"></i> Mola Aralıkları (30dk+)</h4><div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2">${gapsHtml}</div></div>
                                <div class="glass p-4 rounded-xl"><h4 class="text-xs text-gray-400 uppercase font-bold mb-3 flex items-center gap-2"><i class="fa-solid fa-user-clock text-purple-400"></i> Bekleyen Uçuşlar</h4><div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-2">${staffPendingHtml}</div></div>
                            </div>
                        </div>`;
                    },
                    generatePDF: async () => {
                        const { jsPDF } = window.jspdf; const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
                        app.ui.toast("PDF Hazırlanıyor...", "info");
                        const trMap = (str) => str.replace(/Ğ/g, "G").replace(/ğ/g, "g").replace(/Ü/g, "U").replace(/ü/g, "u").replace(/Ş/g, "S").replace(/ş/g, "s").replace(/İ/g, "I").replace(/ı/g, "i").replace(/Ö/g, "O").replace(/ö/g, "o").replace(/Ç/g, "C").replace(/ç/g, "c");

                        // Premium Header with gradient effect
                        doc.setFillColor(15, 23, 42); doc.rect(0, 0, 297, 44, 'F');
                        doc.setFillColor(30, 58, 138); doc.rect(0, 44, 297, 2, 'F');
                        doc.setFillColor(59, 130, 246); doc.rect(0, 45, 297, 1, 'F');

                        // Logo with glow effect
                        doc.setFillColor(30, 41, 59); doc.roundedRect(10, 8, 55, 28, 3, 3, 'F');
                        doc.setDrawColor(59, 130, 246); doc.setLineWidth(0.5); doc.roundedRect(10, 8, 55, 28, 3, 3, 'S');
                        doc.setTextColor(255, 255, 255); doc.setFontSize(18); doc.setFont("helvetica", "bold");
                        doc.text("FOLLOW-ME", 37.5, 20, { align: 'center' });
                        doc.setTextColor(59, 130, 246); doc.setFontSize(11); doc.text("OPS CENTER", 37.5, 28, { align: 'center' });

                        // Report Title with decoration
                        doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.setFont("helvetica", "bold");
                        doc.text("VARDIYA RAPORU", 148, 18, { align: 'center' });
                        doc.setDrawColor(59, 130, 246); doc.setLineWidth(0.5);
                        doc.line(100, 22, 196, 22);

                        let reportDate = new Date(); if (app.state.baseDate) { reportDate = new Date(app.state.baseDate); }
                        const dateStr = trMap(reportDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }));
                        doc.setTextColor(148, 163, 184); doc.setFontSize(11); doc.setFont("helvetica", "normal");
                        doc.text(dateStr.toUpperCase(), 148, 30, { align: 'center' });

                        let shiftStr = "TUM GUN"; let shiftClr = [148, 163, 184];
                        if (app.state.shift !== 'all') {
                            const hStart = Math.floor(app.state.customStart / 60); const hEnd = Math.floor((app.state.customEnd > 1440 ? app.state.customEnd - 1440 : app.state.customEnd) / 60);
                            const rangeStr = `${String(hStart).padStart(2, '0')}:00 - ${String(hEnd).padStart(2, '0')}:00`;
                            shiftStr = app.state.shift === 'day' ? `GUNDUZ VARDIYASI | ${rangeStr}` : `GECE VARDIYASI | ${rangeStr}`;
                            shiftClr = app.state.shift === 'day' ? [251, 191, 36] : [129, 140, 248];
                        }
                        doc.setTextColor(...shiftClr); doc.setFontSize(10); doc.setFont("helvetica", "bold");
                        doc.text(shiftStr, 148, 38, { align: 'center' });

                        const buffer = 20; const flights = app.state.flights; let filteredFlights = [];
                        if (app.state.shift === 'all') { filteredFlights = flights.map(f => ({ ...f, isBuffer: false })); }
                        else {
                            const startM = app.state.customStart; const endM = app.state.customEnd;
                            const bufStart = startM - buffer; const bufEnd = endM + buffer;
                            filteredFlights = flights.filter(f => { const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0); return (m >= bufStart && m <= bufEnd); }).map(f => { const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0); const isBuffer = (m < startM || m > endM); return { ...f, isBuffer }; });
                        }

                        // Enhanced Stats Cards
                        const totalC = filteredFlights.filter(f => !f.isBuffer).length;
                        const doneC = filteredFlights.filter(f => !f.isBuffer && app.state.completed.includes(f.id)).length;
                        const arrC = filteredFlights.filter(f => !f.isBuffer && f.type === 'ARR').length;
                        const depC = filteredFlights.filter(f => !f.isBuffer && f.type === 'DEP').length;
                        const timeChangedC = filteredFlights.filter(f => !f.isBuffer && app.state.timeChanges && app.state.timeChanges[f.id]).length;

                        // Stats Box - simplified
                        doc.setFillColor(30, 41, 59); doc.roundedRect(235, 8, 55, 28, 2, 2, 'F');
                        doc.setDrawColor(59, 130, 246); doc.setLineWidth(0.3); doc.roundedRect(235, 8, 55, 28, 2, 2, 'S');

                        doc.setTextColor(148, 163, 184); doc.setFontSize(7); doc.setFont("helvetica", "normal");
                        doc.text("TOPLAM", 262.5, 14, { align: 'center' });
                        doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.setFont("helvetica", "bold");
                        doc.text(String(totalC), 262.5, 26, { align: 'center' });
                        doc.setFontSize(8);
                        doc.setTextColor(16, 185, 129); doc.text(`${arrC}`, 250, 34);
                        doc.setTextColor(100, 116, 139); doc.text("inis", 258, 34);
                        doc.setTextColor(245, 158, 11); doc.text(`${depC}`, 268, 34);
                        doc.setTextColor(100, 116, 139); doc.text("kalkis", 276, 34);

                        // Build table rows with time change support
                        const rows = filteredFlights.map(f => {
                            const savedGate = app.state.gates[f.id] !== undefined ? app.state.gates[f.id] : (f.originalGate || "");
                            const isGateChanged = String(savedGate).trim() !== String(f.originalGate || "").trim();
                            const gateDisplay = isGateChanged ? `${savedGate} (!)` : savedGate;

                            // Saat değişikliği kontrolü
                            const timeChange = app.state.timeChanges && app.state.timeChanges[f.id];
                            let timeDisplay = f.timeStr;
                            if (timeChange) {
                                timeDisplay = `${timeChange.original} > ${timeChange.new}`;
                            }

                            const isCompleted = app.state.completed.includes(f.id);
                            return [
                                timeDisplay,
                                f.type === 'ARR' ? 'GELIS' : 'GIDIS',
                                f.flightNo,
                                trMap(f.airline),
                                gateDisplay,
                                trMap(f.route),
                                trMap(app.state.assignments[f.id] || '-'),
                                isCompleted ? 'TAMAMLANDI' : 'BEKLIYOR'
                            ];
                        });

                        doc.autoTable({
                            startY: 46,
                            margin: { top: 15, bottom: 30, left: 10, right: 10 },
                            tableWidth: 'auto',
                            head: [['SAAT', 'TIP', 'UCUS NO', 'HAVAYOLU', 'PARK', 'ROTA', 'SORUMLU', 'DURUM']],
                            body: rows,
                            theme: 'striped',
                            styles: { font: 'helvetica', fontSize: 9, cellPadding: 3, textColor: [51, 65, 85], overflow: 'linebreak' },
                            headStyles: { fillColor: [30, 41, 59], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 8, cellPadding: 3.5 },
                            columnStyles: {
                                0: { fontStyle: 'bold', halign: 'center', cellWidth: 32 },
                                1: { fontStyle: 'bold', halign: 'center', cellWidth: 24 },
                                2: { fontStyle: 'bold', halign: 'center', cellWidth: 34 },
                                3: { halign: 'left', cellWidth: 42 },
                                4: { fontStyle: 'bold', halign: 'center', cellWidth: 24 },
                                5: { halign: 'center', cellWidth: 38 },
                                6: { halign: 'center', cellWidth: 48 },
                                7: { halign: 'center', cellWidth: 35, fontStyle: 'bold' }
                            },
                            alternateRowStyles: { fillColor: [248, 250, 252] },
                            didParseCell: (data) => {
                                if (data.section === 'body') {
                                    const flight = filteredFlights[data.row.index];
                                    if (flight && flight.isBuffer) {
                                        data.cell.styles.textColor = [156, 163, 175];
                                        data.cell.styles.fontStyle = 'italic';
                                    } else {
                                        if (data.column.index === 0 && data.cell.raw.includes('>')) {
                                            data.cell.styles.textColor = [59, 130, 246];
                                            data.cell.styles.fontStyle = 'bold';
                                        }
                                        if (data.column.index === 1) {
                                            data.cell.styles.textColor = data.cell.raw === 'GELIS' ? [16, 185, 129] : [245, 158, 11];
                                        }
                                        if (data.column.index === 4 && data.cell.raw.includes('(!)')) {
                                            data.cell.styles.textColor = [239, 68, 68];
                                        }
                                        if (data.column.index === 7) {
                                            data.cell.styles.textColor = data.cell.raw === 'TAMAMLANDI' ? [16, 185, 129] : [148, 163, 184];
                                        }
                                    }
                                }
                            }
                        });

                        // Footer with explanations
                        const pageCount = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            doc.setPage(i);

                            // Footer area - A4 landscape = 210mm height, table ends at 180mm (210-30 margin)
                            const footerY = 180;

                            // Page info
                            doc.setFontSize(8); doc.setTextColor(100, 116, 139); doc.setFont("helvetica", "normal");
                            doc.text("FOLLOW-ME OPS CENTER", 14, footerY);
                            doc.text(`Sayfa ${i} / ${pageCount}`, 148, footerY, { align: 'center' });
                            doc.text(new Date().toLocaleDateString('tr-TR'), 283, footerY, { align: 'right' });

                            // Separator line
                            doc.setDrawColor(200, 210, 220); doc.setLineWidth(0.3);
                            doc.line(14, footerY + 3, 283, footerY + 3);

                            // Explanatory notes
                            doc.setFontSize(6); doc.setTextColor(100, 116, 139);
                            let notesY = footerY + 8;
                            doc.text("(!) isaretli park alanlari manuel degistirilmistir.", 14, notesY);
                            if (timeChangedC > 0) {
                                doc.setTextColor(59, 130, 246);
                                doc.text(`Mavi ile gosterilen saatler degistirilmistir (eski saat > yeni saat formatinda). Toplam ${timeChangedC} saat degisikligi.`, 14, notesY + 4);
                                notesY += 4;
                            }
                            doc.setTextColor(100, 116, 139);
                            doc.text("Not: Vardiya sorumluluk sahasinin ±20 dakika toleransindaki ucuslar rapora dahil edilmistir.", 14, notesY + 4);
                        }

                        doc.save(`FollowMe_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
                        app.ui.toast("PDF İndirildi", "success");
                    },
                    generateVisualReport: async () => {
                        app.ui.toast("Görsel Hazırlanıyor...", "info");
                        const container = document.createElement('div'); container.id = 'reportCapture';
                        container.style.cssText = 'position:fixed;left:0;top:0;width:1200px;height:675px;z-index:9999';
                        document.body.appendChild(container);
                        const flights = app.state.flights; let plannedCount = 0;
                        const shiftFiltered = flights.filter(f => {
                            const date = new Date(f.timestamp); const m = date.getHours() * 60 + date.getMinutes() + (f.isNextDay ? 1440 : 0);
                            if (app.state.shift === 'all') return true;
                            return (m >= app.state.customStart && m <= app.state.customEnd);
                        });
                        shiftFiltered.forEach(f => { plannedCount++; });
                        const servedIDs = app.state.completed; const servedFlights = flights.filter(f => servedIDs.includes(f.id)); const servedCount = servedFlights.length;
                        const servedArr = servedFlights.filter(f => f.type === 'ARR').length; const servedDep = servedFlights.filter(f => f.type === 'DEP').length;
                        const totalArr = shiftFiltered.filter(f => f.type === 'ARR').length; const totalDep = shiftFiltered.filter(f => f.type === 'DEP').length;
                        const dateStr = app.state.baseDate ? new Date(app.state.baseDate).toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) : new Date().toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        const hStart = Math.floor(app.state.customStart / 60); const hEnd = Math.floor((app.state.customEnd > 1440 ? app.state.customEnd - 1440 : app.state.customEnd) / 60);
                        const rangeStr = app.state.shift === 'all' ? 'TÜM GÜN' : `${String(hStart).padStart(2, '0')}:00 - ${String(hEnd).padStart(2, '0')}:00`;
                        const shiftName = app.state.shift === 'all' ? 'TÜM GÜN' : (app.state.shift === 'day' ? 'GÜNDÜZ VARDİYASI' : 'GECE VARDİYASI');
                        const shiftColor = app.state.shift === 'day' ? '#fbbf24' : (app.state.shift === 'night' ? '#818cf8' : '#94a3b8');
                        const shiftGradient = app.state.shift === 'day' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : (app.state.shift === 'night' ? 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)' : 'linear-gradient(135deg, #64748b 0%, #475569 100%)');

                        container.innerHTML = `<div style="width:100%;height:100%;background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f172a 100%);padding:40px;font-family:'Inter',sans-serif;display:flex;flex-direction:column;position:relative;overflow:hidden;">
                            <div style="position:absolute;top:-100px;right:-100px;width:400px;height:400px;background:radial-gradient(circle,rgba(59,130,246,0.12) 0%,transparent 70%);border-radius:50%;"></div>
                            <div style="position:absolute;bottom:-100px;left:-100px;width:350px;height:350px;background:radial-gradient(circle,rgba(16,185,129,0.10) 0%,transparent 70%);border-radius:50%;"></div>
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;z-index:10;margin-bottom:30px;">
                                <div>
                                    <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;">
                                        <div style="width:45px;height:45px;background:${shiftGradient};border-radius:12px;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px -5px ${shiftColor}55;">
                                            <svg style="width:24px;height:24px;color:white;" fill="currentColor" viewBox="0 0 24 24"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg>
                                        </div>
                                        <div style="font-size:12px;font-weight:600;color:#64748b;letter-spacing:3px;text-transform:uppercase;">Vardiya Performans Raporu</div>
                                    </div>
                                    <div style="font-size:36px;font-weight:800;color:white;line-height:1.1;margin-bottom:6px;">${shiftName}</div>
                                    <div style="display:flex;align-items:center;gap:16px;">
                                        <span style="font-size:16px;color:#94a3b8;font-weight:500;">${dateStr}</span>
                                        <span style="font-size:12px;color:${shiftColor};font-weight:700;background:rgba(255,255,255,0.05);padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);">${rangeStr}</span>
                                    </div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1.5fr 1fr;gap:20px;z-index:10;flex:1;">
                                <div style="background:rgba(30,41,59,0.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:24px;display:flex;flex-direction:column;justify-content:center;">
                                    <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;">Planlanan</div>
                                    <div style="font-size:52px;font-weight:800;color:#94a3b8;line-height:1;">${plannedCount}</div>
                                    <div style="font-size:11px;color:#475569;margin-top:8px;">toplam uçuş</div>
                                </div>
                                <div style="background:linear-gradient(135deg,rgba(16,185,129,0.12) 0%,rgba(16,185,129,0.04) 100%);backdrop-filter:blur(10px);border:1px solid rgba(16,185,129,0.25);border-radius:20px;padding:28px;position:relative;overflow:hidden;">
                                    <div style="position:absolute;top:-25px;right:-25px;width:90px;height:90px;background:rgba(16,185,129,0.08);border-radius:50%;"></div>
                                    <div style="font-size:10px;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:2px;margin-bottom:8px;">Hizmet Verilen</div>
                                    <div style="font-size:64px;font-weight:800;color:white;line-height:1;text-shadow:0 4px 16px rgba(16,185,129,0.3);">${servedCount}</div>
                                    <div style="display:flex;gap:12px;margin-top:18px;">
                                        <div style="background:rgba(16,185,129,0.12);padding:8px 14px;border-radius:10px;display:flex;align-items:center;gap:8px;border:1px solid rgba(16,185,129,0.15);">
                                            <svg style="width:14px;height:14px;color:#34d399;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                                            <span style="font-size:18px;font-weight:800;color:white;">${servedArr}</span>
                                            <span style="font-size:10px;font-weight:700;color:#34d399;text-transform:uppercase;">Geliş</span>
                                        </div>
                                        <div style="background:rgba(245,158,11,0.12);padding:8px 14px;border-radius:10px;display:flex;align-items:center;gap:8px;border:1px solid rgba(245,158,11,0.15);">
                                            <svg style="width:14px;height:14px;color:#fbbf24;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
                                            <span style="font-size:18px;font-weight:800;color:white;">${servedDep}</span>
                                            <span style="font-size:10px;font-weight:700;color:#fbbf24;text-transform:uppercase;">Gidiş</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="background:rgba(30,41,59,0.6);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:24px;display:flex;flex-direction:column;justify-content:center;">
                                    <div style="font-size:10px;font-weight:700;color:#64748b;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;">Planlanan Dağılım</div>
                                    <div style="display:flex;flex-direction:column;gap:10px;margin-top:10px;">
                                        <div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;background:#10b981;border-radius:50%;"></div><span style="font-size:14px;color:white;font-weight:600;">${totalArr}</span><span style="font-size:11px;color:#64748b;">geliş</span></div>
                                        <div style="display:flex;align-items:center;gap:8px;"><div style="width:10px;height:10px;background:#f59e0b;border-radius:50%;"></div><span style="font-size:14px;color:white;font-weight:600;">${totalDep}</span><span style="font-size:11px;color:#64748b;">gidiş</span></div>
                                    </div>
                                </div>
                            </div>
                            <div style="z-index:10;margin-top:20px;">
                                <div style="font-size:14px;color:#cbd5e1;font-weight:400;line-height:1.6;border-left:3px solid #3b82f6;padding:14px 18px;background:rgba(59,130,246,0.04);border-radius:0 10px 10px 0;">
                                    Vardiyamızda <span style="color:white;font-weight:600;">${plannedCount}</span> adet uçuş planlanmış olup, <span style="color:#34d399;font-weight:600;">${servedArr}</span> geliş ve <span style="color:#fbbf24;font-weight:600;">${servedDep}</span> gidiş olmak üzere toplam <span style="color:#10b981;font-weight:600;">${servedCount}</span> adet Follow-Me hizmeti verilmiştir.
                                </div>
                            </div>
                            <div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid rgba(255,255,255,0.06);padding-top:16px;z-index:10;margin-top:20px;">
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <div style="width:6px;height:6px;background:#10b981;border-radius:50%;box-shadow:0 0 8px #10b981;"></div>
                                    <span style="font-size:10px;color:#475569;font-weight:600;text-transform:uppercase;letter-spacing:1px;">Follow-Me Ops Center</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:#10b981;background:rgba(16,185,129,0.08);padding:6px 12px;border-radius:6px;">
                                    <svg style="width:12px;height:12px;" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                                    Vardiya Tamamlandı
                                </div>
                            </div>
                        </div>`;
                        try {
                            const canvas = await html2canvas(container, { backgroundColor: null, scale: 2 });
                            const link = document.createElement('a');
                            link.download = `Vardiya_Ozeti_${new Date().toISOString().slice(0, 10)}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                            document.body.removeChild(container);
                            app.ui.toast("Görsel İndirildi", "success");
                        } catch (err) { console.error("Canvas error:", err); document.body.removeChild(container); app.ui.toast("Görsel Hatası", "error"); }
                    },

                },
                data: {
                    // Firebase'e kaydet - SADECE ADMİN
                    save: () => {
                        // Admin değilse kaydetme!
                        if (!app.isAdmin) {
                            console.log('⚠️ Kullanıcı modunda kayıt yapılamaz');
                            return;
                        }

                        // Firebase'e kaydet
                        if (typeof firebaseDB !== 'undefined') {
                            firebaseDB.ref('appState').set(app.state)
                                .then(() => {
                                    const el = document.getElementById('saveStatus');
                                    if (el) {
                                        el.style.opacity = '1';
                                        el.innerHTML = '<i class="fa-solid fa-cloud-arrow-up animate-bounce text-green-400"></i> <span class="text-green-400">SENKRON</span>';
                                        setTimeout(() => el.style.opacity = '0', 2000);
                                    }
                                    console.log('✅ Firebase\'e kaydedildi');
                                })
                                .catch(err => {
                                    console.error('Firebase save error:', err);
                                    app.ui.toast('Senkronizasyon hatası', 'error');
                                });
                        }
                    },

                    // Firebase'den yükle ve gerçek zamanlı dinle
                    load: () => {
                        // Firebase gerçek zamanlı listener - TEK KAYNAK
                        if (typeof firebaseDB !== 'undefined') {
                            firebaseDB.ref('appState').on('value', (snapshot) => {
                                const data = snapshot.val();
                                if (data) {
                                    // isAdmin'i koru - Firebase'den gelen isAdmin'i yok say
                                    if (data.isAdmin !== undefined) delete data.isAdmin;

                                    // State'i güncelle
                                    app.state = {
                                        flights: data.flights || [],
                                        shift: data.shift || 'day',
                                        customStart: data.customStart || 480,
                                        customEnd: data.customEnd || 1200,
                                        staff: data.staff || ['AHMET Y.', 'MEHMET K.', 'AYŞE D.', 'FATMA S.', 'CAN B.'],
                                        assignments: data.assignments || {},
                                        gates: data.gates || {},
                                        overrides: data.overrides || {},
                                        completed: data.completed || [],
                                        delayed: data.delayed || {},
                                        timeChanges: data.timeChanges || {},
                                        showCompleted: data.showCompleted !== undefined ? data.showCompleted : true,
                                        filterMode: data.filterMode || 'all',
                                        baseDate: data.baseDate || null,
                                        history: data.history || [],
                                        flightHistory: data.flightHistory || {},
                                        showUpdatedOnly: data.showUpdatedOnly || false
                                    };

                                    // UI'ı güncelle
                                    app.ui.render();
                                    app.ui.renderStaff();
                                    app.ui.updateHeaderShiftLabel();
                                    app.ui.updateAdminUI(); // Her seferinde admin UI'ı güncelle!

                                    // Senkronizasyon bildirimi
                                    const el = document.getElementById('saveStatus');
                                    if (el) {
                                        el.style.opacity = '1';
                                        el.innerHTML = '<i class="fa-solid fa-cloud-arrow-down text-blue-400"></i> <span class="text-blue-400">GÜNCELLENDİ</span>';
                                        setTimeout(() => el.style.opacity = '0', 3000);
                                    }
                                }
                            });
                            console.log('🔥 Firebase Realtime Database bağlandı!');
                        } else {
                            console.warn('⚠️ Firebase bağlantısı yok!');
                        }
                    },

                    saveToJson: () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(app.state)], { type: 'application/json' })); a.download = `backup_${Date.now()}.json`; a.click(); },
                    loadFromJson: (input) => { const f = input.files[0]; if (!f) return; const r = new FileReader(); r.onload = (e) => { app.state = JSON.parse(e.target.result); if (!app.state.delayed) app.state.delayed = {}; app.ui.render(); app.ui.renderStaff(); app.ui.updateHeaderShiftLabel(); app.data.save(); app.ui.toast("Yedek Yüklendi", "success"); }; r.readAsText(f); },
                    reset: () => { app.ui.smartReset(); }
                }
            };
            window.addEventListener('DOMContentLoaded', app.init);
        </script>
</body>

</html>